<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GoAccel Concierge</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e8f0ff;
      --user: #e0f2fe;
      --bot: #f3f4f6;
      --danger: #ef4444;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #e0edff 0, var(--bg) 45%, #e5e7eb 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
    }
    .widget {
      width: min(440px, 100%);
      background: var(--panel);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 20px;
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.22);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(12px);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: #f9fafb;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent-soft);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--accent);
      border: 1px solid var(--border);
    }
    .title { margin: 0; font-size: 16px; font-weight: 700; }
    .subtitle { margin: 0; font-size: 12px; color: var(--muted); }
    .messages {
      padding: 16px;
      height: 480px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
    }
    .msg {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid var(--border);
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    .msg.user { align-self: flex-end; background: var(--user); }
    .msg.bot { align-self: flex-start; background: var(--bot); }
    .msg.error { background: #fff1f2; border-color: #fecdd3; color: #991b1b; }
    .msg.meta {
      align-self: center;
      border-style: dashed;
      background: #f9fafb;
      color: var(--muted);
      font-size: 12px;
    }
    .chips { display: flex; flex-direction: column; gap: 10px; }
    .chip {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      width: 100%;
      text-align: left;
    }
    .chip:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
      transform: translateY(-1px);
    }
    .input-shell {
      border-top: 1px solid var(--border);
      background: #fff;
    }
    .input-area {
      padding: 10px 12px 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .input-box {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
    }
    .input-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12); }
    .send-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      min-width: 80px;
      font-size: 14px;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
    }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    .mic-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mic-btn:hover { background: #f3f4f6; color: var(--accent); border-color: var(--accent); }
    .mic-btn.recording {
      background: #fee2e2;
      color: #ef4444;
      border-color: #ef4444;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .hint-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 14px 8px;
      font-size: 11px;
      color: var(--muted);
      gap: 8px;
    }
    .hint-row span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .section-title { margin: 0 0 6px; color: var(--muted); font-size: 13px; }
    .footer {
      text-align: center;
      padding: 6px 10px 10px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid var(--border);
      background: #f9fafb;
    }
    .typing-dot {
      display: inline-block;
      width: 4px;
      height: 4px;
      margin: 0 1px;
      border-radius: 999px;
      background: var(--muted);
      animation: blink 1.1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-1px); }
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="widget">
    <div class="header">
      <div class="avatar" id="businessAvatar">GA</div>
      <div>
        <p class="title" id="businessTitle">GoAccel Concierge</p>
        <p class="subtitle" id="businessSubtitle">Ask about services, pricing or booking ‚Äì 24/7</p>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-shell">
      <!-- Call Button Row (Optional - only shown if business has voice enabled) -->
      <div id="voiceCallSection" style="display: none; padding: 10px 14px 0 14px; border-bottom: 1px solid var(--border);">
        <details>
          <summary style="cursor: pointer; color: var(--accent); font-size: 13px; font-weight: 600; padding-bottom: 8px;">
            üìû Make a Phone Call
          </summary>
          <div style="padding: 10px 0;">
            <input id="phoneNumber" type="tel" placeholder="+1234567890" 
              style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px;">
            <button id="callBtn" class="send-btn" style="width: 100%;">Start Call</button>
            <div id="callStatus" style="font-size: 11px; color: var(--muted); margin-top: 6px;"></div>
          </div>
        </details>
      </div>

      <div class="input-area">
        <input id="message" class="input-box" placeholder="Type a question or say hi to start..." />
        <button id="micBtn" class="mic-btn" title="Hold to speak">
           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        </button>
        <button id="sendBtn" class="send-btn" disabled>Send</button>
        <input id="userId" class="hidden" value="demo-user" />
      </div>
      <div class="hint-row">
        <span>Try: ‚ÄúWhat can you help me with?‚Äù</span>
        <span id="charCount">0/300</span>
      </div>
    </div>

    <div class="footer" id="businessFooter">Powered by GoAccel ‚Ä¢ AI assistant demo</div>
  </div>

  <script>
    // Get business_id from URL parameter - REQUIRED
    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get('business_id');
    
    // Redirect to admin if business_id is missing
    if (!businessId) {
      window.location.href = '/admin';
    }
    
    // Default configuration (will be overridden by API if business exists)
    let CHATBOT_CONFIG = {
      businessId: businessId,
      businessName: null,
      businessPrimaryGoal: "Generate more leads.",
      personalityPrompt: "Gentle, collaborative and to the point.",
      greetingMessage: "Hi - How can we help you today?",
      privacyStatement:
        "We collect contact information only for keeping you up to date regarding our products, services, and special offers. Please review our privacy policy for more details.",
      themeColor: "#2563eb",
      widgetPosition: "center",
      appointmentLink: "https://example.com/book",
    };
    
    // Generate avatar initials from business name
    function getInitials(name) {
      if (!name) return "GA";
      const words = name.trim().split(/\s+/);
      if (words.length >= 2) {
        return (words[0][0] + words[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    // Update business branding in UI
    function updateBusinessBranding() {
      const businessName = CHATBOT_CONFIG.businessName;
      if (businessName) {
        // Update avatar
        const avatarEl = document.getElementById('businessAvatar');
        if (avatarEl) avatarEl.textContent = getInitials(businessName);
        // Update title
        const titleEl = document.getElementById('businessTitle');
        if (titleEl) titleEl.textContent = businessName;
        // Update subtitle
        const subtitleEl = document.getElementById('businessSubtitle');
        if (subtitleEl) subtitleEl.textContent = "Ask about services, pricing or booking ‚Äì 24/7";
        // Update footer
        const footerEl = document.getElementById('businessFooter');
        if (footerEl) footerEl.textContent = `Powered by ${businessName} ‚Ä¢ AI assistant`;
        // Update page title
        document.title = `${businessName} - Chat Assistant`;
      }
    }
    
    // Base API URL helper
    // Detects the current port or defaults to port 80 if on file://
    function getApiUrl(path) {
      if (window.location.protocol === 'file:') {
        return `http://localhost${path}`;
      }
      return path;
    }

    // Load business configuration from API
    async function loadBusinessConfig() {
      try {
        // Added a timestamp to bypass browser cache
        const apiUrl = getApiUrl(`/api/business/${businessId}/config?t=${Date.now()}`);
        
        const res = await fetch(apiUrl);
        if (!res.ok) {
          // If business not found, redirect to admin
          if (res.status === 404) {
            alert('Business not found. Redirecting to admin panel...');
            window.location.href = '/admin';
            return;
          }
          throw new Error(`HTTP ${res.status}`);
        }
        
        const config = await res.json();
        CHATBOT_CONFIG = {
          businessId: config.businessId || businessId,
          businessName: config.businessName || CHATBOT_CONFIG.businessName,
          businessPrimaryGoal: config.businessPrimaryGoal || CHATBOT_CONFIG.businessPrimaryGoal,
          personalityPrompt: config.personalityPrompt || CHATBOT_CONFIG.personalityPrompt,
          greetingMessage: config.greetingMessage || CHATBOT_CONFIG.greetingMessage,
          privacyStatement: config.privacyStatement || CHATBOT_CONFIG.privacyStatement,
          themeColor: config.themeColor || CHATBOT_CONFIG.themeColor,
          widgetPosition: config.widgetPosition || CHATBOT_CONFIG.widgetPosition,
          appointmentLink: config.appointmentLink || CHATBOT_CONFIG.appointmentLink,
          voiceEnabled: config.voiceEnabled || false, // Check if voice is enabled
        };
        // Apply config immediately
        applyConfig();
        updateBusinessBranding();
        
        // Show/hide voice call section based on config
        const voiceSection = document.getElementById('voiceCallSection');
        if (voiceSection) {
          voiceSection.style.display = CHATBOT_CONFIG.voiceEnabled ? 'block' : 'none';
        }
      } catch (err) {
        console.error('Error loading business config:', err);
        alert('Failed to load business configuration. Redirecting to admin panel...');
        window.location.href = '/admin';
      }
    }
    
    // Load config on page load
    loadBusinessConfig();

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("message");
    const userIdEl = document.getElementById("userId");
    const sendBtn = document.getElementById("sendBtn");
    // micBtn is declared later with the recording logic
    const quickOptionsEl = null;
    let typingNode = null;
    let ctaConfig = {}; // Using dynamic CTA tree system only

    // --- Voice Recording Logic (WAV Encoding) ---
    const micBtn = document.getElementById("micBtn");
    const callBtn = document.getElementById("callBtn");
    const phoneNumberEl = document.getElementById("phoneNumber");
    const callStatusEl = document.getElementById("callStatus");

    if (callBtn) {
      callBtn.addEventListener("click", async () => {
        const phone = phoneNumberEl.value.trim();
        if (!phone) {
          callStatusEl.textContent = "Please enter a valid phone number.";
          return;
        }
        
        callStatusEl.textContent = "Initiating call...";
        callBtn.disabled = true;
        
        try {
          // Use helper
          const callUrl = getApiUrl('/make-call');

          const res = await fetch(callUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone_number: phone })
          });
          
          const data = await res.json();
          if (res.ok) {
            callStatusEl.textContent = `Calling... SID: ${data.call_sid}`;
            addMessage(`üìû Calling ${phone}...`, "bot");
          } else {
            callStatusEl.textContent = `Error: ${data.detail || "Call failed"}`;
          }
        } catch (err) {
          console.error("Call error:", err);
          callStatusEl.textContent = "Error initiating call.";
        } finally {
          callBtn.disabled = false;
        }
      });
    }

    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      micBtn.addEventListener("mousedown", startRecording);
      micBtn.addEventListener("mouseup", stopRecording);
      micBtn.addEventListener("mouseleave", () => {
        if (isRecording) stopRecording();
      });
      micBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        startRecording();
      });
      micBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        stopRecording();
      });
    } else {
      micBtn.style.display = "none";
      console.warn("MediaDevices API not supported.");
    }

    async function startRecording() {
        if (isRecording) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = async () => {
                const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
                // Convert to WAV
                const arrayBuffer = await webmBlob.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                const wavBlob = audioBufferToWav(audioBuffer);

                sendVoiceMessage(wavBlob);
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            isRecording = true;
            micBtn.classList.add("recording");
            inputEl.placeholder = "Listening...";
        } catch (err) {
            console.error("Mic Error:", err);
            addMessage("Could not access microphone.", "error");
        }
    }

    function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        micBtn.classList.remove("recording");
        inputEl.placeholder = "Type a question or say hi to start...";
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
        }
    }

    // Function to convert AudioBuffer to WAV
    function audioBufferToWav(buffer, opt) {
        opt = opt || {};
        var numChannels = buffer.numberOfChannels;
        var sampleRate = buffer.sampleRate;
        var format = opt.float32 ? 3 : 1;
        var bitDepth = format === 3 ? 32 : 16;
        var result;
        if (numChannels === 2) result = interleave(buffer.getChannelData(0), buffer.getChannelData(1));
        else result = buffer.getChannelData(0);
        return encodeWAV(result, format, sampleRate, numChannels, bitDepth);
    }

    function interleave(inputL, inputR) {
        var length = inputL.length + inputR.length;
        var result = new Float32Array(length);
        var index = 0, inputIndex = 0;
        while (index < length) {
            result[index++] = inputL[inputIndex];
            result[index++] = inputR[inputIndex++];
        }
        return result;
    }

    function encodeWAV(samples, format, sampleRate, numChannels, bitDepth) {
        var bytesPerSample = bitDepth / 8;
        var blockAlign = numChannels * bytesPerSample;
        var buffer = new ArrayBuffer(44 + samples.length * bytesPerSample);
        var view = new DataView(buffer);
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + samples.length * bytesPerSample, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, format, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * blockAlign, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitDepth, true);
        writeString(view, 36, 'data');
        view.setUint32(40, samples.length * bytesPerSample, true);
        if (format === 1) floatTo16BitPCM(view, 44, samples);
        else writeFloat32(view, 44, samples);
        return new Blob([view], { type: 'audio/wav' });
    }

    function floatTo16BitPCM(output, offset, input) {
        for (var i = 0; i < input.length; i++, offset += 2) {
            var s = Math.max(-1, Math.min(1, input[i]));
            output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }
    }

    function writeFloat32(output, offset, input) {
        for (var i = 0; i < input.length; i++, offset += 4) {
            output.setFloat32(offset, input[i], true);
        }
    }

    function writeString(view, offset, string) {
        for (var i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    async function sendVoiceMessage(audioBlob) {
      showTyping();
      const formData = new FormData();
      // Filename is important for backend to detect type if needed, though we handle generic bytes
      formData.append("file", audioBlob, "recording.wav"); 

      try {
        addMessage("üé§ Audio sent...", "user");
        
        // Use helper
        const voiceUrl = getApiUrl('/api/voice/chat');

        const res = await fetch(voiceUrl, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Server error: ${res.status} - ${errorText}`);
        }

        // The response is a WAV file blob
        const wavBlob = await res.blob();
        const audioUrl = URL.createObjectURL(wavBlob);
        
        // Play the audio response
        const audio = new Audio(audioUrl);
        audio.play();
        
        hideTyping();
        addMessage("üé§ (Audio Response Playing)", "bot");
        
        // Note: Voice endpoint currently returns ONLY audio. 
        // If you want text transcript + CTAs, the backend endpoint needs to return JSON with { audio_b64, text, ctas }
        // For now, this meets the specific requirement of "voice endpoint integration".
        
      } catch (err) {
        hideTyping();
        console.error("Voice chat error:", err);
        addMessage("Error sending voice message.", "error");
      }
    }
    // -----------------------------

    // Apply theme + position based on config
    function applyConfig() {
      // Theme color
      if (CHATBOT_CONFIG.themeColor) {
        document.documentElement.style.setProperty("--accent", CHATBOT_CONFIG.themeColor);
        document.documentElement.style.setProperty(
          "--accent-soft",
          CHATBOT_CONFIG.themeColor + "20"
        );
      }
      // Position (optional ‚Äì default center for demo)
      const widget = document.querySelector(".widget");
      if (!widget) return;
      if (CHATBOT_CONFIG.widgetPosition === "bottom-right" || CHATBOT_CONFIG.widgetPosition === "bottom-left") {
        widget.style.position = "fixed";
        widget.style.bottom = "20px";
        widget.style[CHATBOT_CONFIG.widgetPosition === "bottom-right" ? "right" : "left"] = "20px";
        document.body.style.alignItems = "flex-end";
        document.body.style.justifyContent =
          CHATBOT_CONFIG.widgetPosition === "bottom-right" ? "flex-end" : "flex-start";
      }
    }

    // Apply immediately with defaults
    applyConfig();
    // Removed primary/secondary CTA tracking - using dynamic CTA tree system
    let lastOptionsNode = null;

    function clearOptions() {
      if (lastOptionsNode && lastOptionsNode.parentNode) {
        lastOptionsNode.parentNode.removeChild(lastOptionsNode);
      }
      lastOptionsNode = null;
    }

    function addMessage(text, role = "bot") {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.innerHTML = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTyping() {
      if (typingNode) return;
      const wrap = document.createElement("div");
      wrap.className = "msg bot";
      const dots = document.createElement("span");
      dots.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
      wrap.appendChild(dots);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      typingNode = wrap;
    }

    function hideTyping() {
      if (typingNode && typingNode.parentNode) {
        typingNode.parentNode.removeChild(typingNode);
      }
      typingNode = null;
    }

    function addOptionChips(options, type) {
      if (!options || !options.length) return;
      // remove previous option block to avoid duplicates
      if (lastOptionsNode && lastOptionsNode.parentNode) {
        lastOptionsNode.parentNode.removeChild(lastOptionsNode);
      }
      // Removed primary/secondary tracking - using dynamic CTA system
      const wrap = document.createElement("div");
      wrap.className = "msg bot";
      const row = document.createElement("div");
      row.className = "chips";
      options.forEach((option) => {
        const label = option.label || "";
        const action = option.action || "send";
        const message = option.message || label;
        const icon = option.icon;
        if (!label) return;
        const btn = document.createElement("button");
        btn.className = "chip";
        btn.type = "button";
        btn.textContent = icon ? `${icon} ${label}` : label;
        btn.addEventListener("click", () => {
          // Legacy show_secondary action removed - use CTA tree instead
          sendMessage(message);
        });
        row.appendChild(btn);
      });
      wrap.appendChild(row);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      lastOptionsNode = wrap;
      // Removed primary/secondary tracking - using dynamic CTA system
    }

    function buildBusinessSystemPrompt() {
      const parts = [];
      if (CHATBOT_CONFIG.businessPrimaryGoal) {
        parts.push(`Business primary goal: ${CHATBOT_CONFIG.businessPrimaryGoal}`);
      }
      if (CHATBOT_CONFIG.personalityPrompt) {
        parts.push(`Assistant personality: ${CHATBOT_CONFIG.personalityPrompt}`);
      }
      if (CHATBOT_CONFIG.greetingMessage) {
        parts.push(`Preferred greeting style: "${CHATBOT_CONFIG.greetingMessage}"`);
      }
      if (CHATBOT_CONFIG.privacyStatement) {
        parts.push(
          "When collecting PII, reassure the user with this privacy statement: " +
            CHATBOT_CONFIG.privacyStatement.replace(/\s+/g, " ")
        );
      }
      return parts.join("\n");
    }

    async function sendMessage(messageOverride) {
      const message = (messageOverride ?? inputEl.value).trim();
      const userId = userIdEl.value.trim() || "default_user";
      if (!message) return;

      const normalizedInput = message.toLowerCase();
      if (["hi", "hello", "hey"].includes(normalizedInput)) {
        clearOptions();
      }

      addMessage(message, "user");
      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;
      document.getElementById("charCount").textContent = "0/300";
      showTyping();

      try {
        console.log("Sending message to /chat:", {
          message,
          user_id: userId,
          business_id: CHATBOT_CONFIG.businessId
        });
        
        // Use helper
        const chatUrl = getApiUrl('/chat');
        
        const res = await fetch(chatUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            user_id: userId,
            business_id: CHATBOT_CONFIG.businessId,
            system_prompt: buildBusinessSystemPrompt(),
            appointment_link: CHATBOT_CONFIG.appointmentLink,
          }),
        });
        
        console.log("Response status:", res.status, res.statusText);
        
        // Check if response is OK
        if (!res.ok) {
          const errorText = await res.text();
          console.error("API Error:", res.status, errorText);
          throw new Error(`Server error: ${res.status} - ${errorText.substring(0, 100)}`);
        }
        
        const data = await res.json();
        console.log("Response data:", data);
        const text = data.response || JSON.stringify(data);

        // If the bot lists options in text, keep only the first line for display
        let displayText = text;
        if (text.toLowerCase().includes("please choose one of the options below")) {
          const parts = text.split(/<br>|\\n/).map(p => p.trim()).filter(Boolean);
          if (parts.length) displayText = parts[0];
        }

        hideTyping();
        addMessage(displayText, "bot");

        // Render CTAs from the backend if provided
        if (data.ctas && Array.isArray(data.ctas.primary)) {
          // Using dynamic CTA system - CTAs come from backend via cta field
      } catch (err) {
        hideTyping();
        console.error("Chat error:", err);
        let errorMsg = "Error connecting to the assistant. ";
        
        if (window.location.protocol === 'file:') {
          errorMsg += "<br><br><b>Tip:</b> Direct file access (file://) is often blocked by browsers. <br>Please visit <b>http://localhost</b> in your browser instead.";
        } else {
          errorMsg += "Please check if the backend is running and reachable.";
        }
        
        if (err.message) {
          errorMsg += ` (${err.message})`;
        }
        addMessage(errorMsg, "error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", () => sendMessage());
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    inputEl.addEventListener("input", () => {
      const text = inputEl.value;
      const max = 300;
      const trimmed = text.slice(0, max);
      if (trimmed !== text) {
        inputEl.value = trimmed;
      }
      const current = inputEl.value.trim().length;
      document.getElementById("charCount").textContent = `${current}/${max}`;
      sendBtn.disabled = current === 0;
    });

    // Show privacy + greeting based on config so each client feels customized
    // Wait for config to load, then show initial messages
    async function initializeChat() {
      await loadBusinessConfig(); // Ensure config is loaded
      updateBusinessBranding(); // Update branding from config
      
      // Update CTA config after loading business config
      
      if (CHATBOT_CONFIG.privacyStatement) {
        addMessage(CHATBOT_CONFIG.privacyStatement, "meta");
      }
      const initialGreeting =
        CHATBOT_CONFIG.greetingMessage ||
        "Hi! I'm your AI assistant. Ask anything about services, pricing or booking and I'll guide you.";
      addMessage(initialGreeting, "bot");
      
      // CTAs are now handled dynamically via the CTA tree system from backend
    }
    
    // Initialize chat after page loads
    initializeChat();
  </script>
</body>
</html>
