<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WarmProspect Concierge</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e8f0ff;
      --user: #e0f2fe;
      --bot: #f3f4f6;
      --danger: #ef4444;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #e0edff 0, var(--bg) 45%, #e5e7eb 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
    }
    .widget {
      width: min(440px, 100%);
      background: var(--panel);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 20px;
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.22);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(12px);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: #f9fafb;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent-soft);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--accent);
      border: 1px solid var(--border);
    }
    .title { margin: 0; font-size: 16px; font-weight: 700; }
    .subtitle { margin: 0; font-size: 12px; color: var(--muted); }
    .messages {
      padding: 16px;
      height: 480px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
    }
    .msg {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid var(--border);
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    .msg.user { align-self: flex-end; background: var(--user); }
    .msg.bot { align-self: flex-start; background: var(--bot); }
    .msg.error { background: #fff1f2; border-color: #fecdd3; color: #991b1b; }
    .msg.meta {
      align-self: center;
      border-style: dashed;
      background: #f9fafb;
      color: var(--muted);
      font-size: 12px;
    }
    .chips { display: flex; flex-direction: column; gap: 10px; }
    .chip {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      width: 100%;
      text-align: left;
    }
    .chip:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
      transform: translateY(-1px);
    }
    .input-shell {
      border-top: 1px solid var(--border);
      background: #fff;
    }
    .input-area {
      padding: 10px 12px 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .input-box {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
    }
    .input-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12); }
    .send-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      min-width: 80px;
      font-size: 14px;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
    }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    .hint-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 14px 8px;
      font-size: 11px;
      color: var(--muted);
      gap: 8px;
    }
    .hint-row span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .section-title { margin: 0 0 6px; color: var(--muted); font-size: 13px; }
    .footer {
      text-align: center;
      padding: 6px 10px 10px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid var(--border);
      background: #f9fafb;
    }
    .typing-dot {
      display: inline-block;
      width: 4px;
      height: 4px;
      margin: 0 1px;
      border-radius: 999px;
      background: var(--muted);
      animation: blink 1.1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-1px); }
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="widget">
    <div class="header">
      <div class="avatar" id="businessAvatar">WP</div>
      <div>
        <p class="title" id="businessTitle">WarmProspect Concierge</p>
        <p class="subtitle" id="businessSubtitle">Ask about services, pricing or booking ‚Äì 24/7</p>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-shell">
      <div class="input-area">
        <input id="message" class="input-box" placeholder="Type a question or say hi to start..." />
        <button id="sendBtn" class="send-btn" disabled>Send</button>
        <input id="userId" class="hidden" value="demo-user" />
      </div>
      <div class="hint-row">
        <span>Try: ‚ÄúWhat can you help me with?‚Äù</span>
        <span id="charCount">0/300</span>
      </div>
    </div>

    <div class="footer" id="businessFooter">Powered by WarmProspect ‚Ä¢ AI assistant demo</div>
  </div>

  <script>
    // Get business_id from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get('business_id') || 'demo-business';
    
    // Default configuration (will be overridden by API if business exists)
    let CHATBOT_CONFIG = {
      businessId: businessId,
      businessName: null,
      businessPrimaryGoal: "Generate more leads.",
      personalityPrompt: "Gentle, collaborative and to the point.",
      greetingMessage: "Hi - How can we help you today?",
      privacyStatement:
        "We collect contact information only for keeping you up to date regarding our products, services, and special offers. Please review our privacy policy for more details.",
      themeColor: "#2563eb",
      widgetPosition: "center",
      appointmentLink: "https://example.com/book",
    };
    
    // Generate avatar initials from business name
    function getInitials(name) {
      if (!name) return "WP";
      const words = name.trim().split(/\s+/);
      if (words.length >= 2) {
        return (words[0][0] + words[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    // Update business branding in UI
    function updateBusinessBranding() {
      const businessName = CHATBOT_CONFIG.businessName;
      if (businessName) {
        // Update avatar
        const avatarEl = document.getElementById('businessAvatar');
        if (avatarEl) avatarEl.textContent = getInitials(businessName);
        // Update title
        const titleEl = document.getElementById('businessTitle');
        if (titleEl) titleEl.textContent = businessName;
        // Update subtitle
        const subtitleEl = document.getElementById('businessSubtitle');
        if (subtitleEl) subtitleEl.textContent = "Ask about services, pricing or booking ‚Äì 24/7";
        // Update footer
        const footerEl = document.getElementById('businessFooter');
        if (footerEl) footerEl.textContent = `Powered by ${businessName} ‚Ä¢ AI assistant`;
        // Update page title
        document.title = `${businessName} - Chat Assistant`;
      }
    }
    
    // Load business configuration from API
    async function loadBusinessConfig() {
      try {
        // Use relative URL that works with both http:// and file://
        const apiUrl = window.location.protocol === 'file:' 
          ? `http://localhost:8000/api/business/${businessId}/config`
          : `/api/business/${businessId}/config`;
        
        const res = await fetch(apiUrl);
        if (res.ok) {
          const config = await res.json();
          CHATBOT_CONFIG = {
            businessId: config.businessId || businessId,
            businessName: config.businessName || CHATBOT_CONFIG.businessName,
            businessPrimaryGoal: config.businessPrimaryGoal || CHATBOT_CONFIG.businessPrimaryGoal,
            personalityPrompt: config.personalityPrompt || CHATBOT_CONFIG.personalityPrompt,
            greetingMessage: config.greetingMessage || CHATBOT_CONFIG.greetingMessage,
            privacyStatement: config.privacyStatement || CHATBOT_CONFIG.privacyStatement,
            themeColor: config.themeColor || CHATBOT_CONFIG.themeColor,
            widgetPosition: config.widgetPosition || CHATBOT_CONFIG.widgetPosition,
            appointmentLink: config.appointmentLink || CHATBOT_CONFIG.appointmentLink,
          };
          // Apply config immediately
          applyConfig();
          updateBusinessBranding();
        }
      } catch (err) {
        console.log('Using default config (business not found or API error):', err.message);
      }
    }
    
    // Load config on page load
    loadBusinessConfig();

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("message");
    const userIdEl = document.getElementById("userId");
    const sendBtn = document.getElementById("sendBtn");
    const quickOptionsEl = null;
    let typingNode = null;

    // Apply theme + position based on config
    (function applyConfig() {
      // Theme color
      if (CHATBOT_CONFIG.themeColor) {
        document.documentElement.style.setProperty("--accent", CHATBOT_CONFIG.themeColor);
        document.documentElement.style.setProperty(
          "--accent-soft",
          CHATBOT_CONFIG.themeColor + "20"
        );
      }
      // Position (optional ‚Äì default center for demo)
      const widget = document.querySelector(".widget");
      if (!widget) return;
      if (CHATBOT_CONFIG.widgetPosition === "bottom-right" || CHATBOT_CONFIG.widgetPosition === "bottom-left") {
        widget.style.position = "fixed";
        widget.style.bottom = "20px";
        widget.style[CHATBOT_CONFIG.widgetPosition === "bottom-right" ? "right" : "left"] = "20px";
        document.body.style.alignItems = "flex-end";
        document.body.style.justifyContent =
          CHATBOT_CONFIG.widgetPosition === "bottom-right" ? "flex-end" : "flex-start";
      }
    })();
    let lastRenderedSecondary = 0;
    let primaryRendered = false;
    let secondaryRendered = false;
    let lastOptionsNode = null;

    function clearOptions() {
      if (lastOptionsNode && lastOptionsNode.parentNode) {
        lastOptionsNode.parentNode.removeChild(lastOptionsNode);
      }
      primaryRendered = false;
      secondaryRendered = false;
      lastOptionsNode = null;
    }

    const primaryOptions = [
      { label: "Book an Appointment", icon: "üìÖ" },
      { label: "Speak to Sales", icon: "üí¨" },
      { label: "Send More Information", icon: "üì¶" },
    ];

    const secondaryOptions = [
      { label: "Website Design Services", icon: "üé®" },
      { label: "Digital Agency Services", icon: "üìà" },
      { label: "Business Growth Services", icon: "üöÄ" },
      { label: "CRM Software Platform", icon: "‚öôÔ∏è" },
      { label: "All of the Above", icon: "‚≠ê" },
    ];

    function addMessage(text, role = "bot") {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.innerHTML = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTyping() {
      if (typingNode) return;
      const wrap = document.createElement("div");
      wrap.className = "msg bot";
      const dots = document.createElement("span");
      dots.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
      wrap.appendChild(dots);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      typingNode = wrap;
    }

    function hideTyping() {
      if (typingNode && typingNode.parentNode) {
        typingNode.parentNode.removeChild(typingNode);
      }
      typingNode = null;
    }

    function addOptionChips(options, type) {
      // remove previous option block to avoid duplicates
      if (lastOptionsNode && lastOptionsNode.parentNode) {
        lastOptionsNode.parentNode.removeChild(lastOptionsNode);
      }
      // when switching sets, reset the other flag
      if (type === "secondary") {
        primaryRendered = false;
      }
      if (type === "primary") {
        secondaryRendered = false;
      }
      const wrap = document.createElement("div");
      wrap.className = "msg bot";
      const row = document.createElement("div");
      row.className = "chips";
      options.forEach(({ label, icon }) => {
        const btn = document.createElement("button");
        btn.className = "chip";
        btn.type = "button";
        btn.textContent = `${icon} ${label}`;
        btn.addEventListener("click", () => {
          if (label === "Send More Information") {
            lastRenderedSecondary = Date.now();
            secondaryRendered = false;
            addOptionChips(secondaryOptions, "secondary");
            // Do not send "Send More Information" as user input; just swap options
            return;
          }
          if (label === "All of the Above") {
            sendMessage("Can you explain Website Design Services, Digital Agency Services, Business Growth Services, CRM Software Platform?");
          } else {
            sendMessage(label);
          }
        });
        row.appendChild(btn);
      });
      wrap.appendChild(row);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      lastOptionsNode = wrap;
      if (type === "primary") {
        primaryRendered = true;
        secondaryRendered = false;
      }
      if (type === "secondary") {
        secondaryRendered = true;
        primaryRendered = false;
      }
    }

    function buildBusinessSystemPrompt() {
      const parts = [];
      if (CHATBOT_CONFIG.businessPrimaryGoal) {
        parts.push(`Business primary goal: ${CHATBOT_CONFIG.businessPrimaryGoal}`);
      }
      if (CHATBOT_CONFIG.personalityPrompt) {
        parts.push(`Assistant personality: ${CHATBOT_CONFIG.personalityPrompt}`);
      }
      if (CHATBOT_CONFIG.greetingMessage) {
        parts.push(`Preferred greeting style: "${CHATBOT_CONFIG.greetingMessage}"`);
      }
      if (CHATBOT_CONFIG.privacyStatement) {
        parts.push(
          "When collecting PII, reassure the user with this privacy statement: " +
            CHATBOT_CONFIG.privacyStatement.replace(/\s+/g, " ")
        );
      }
      return parts.join("\n");
    }

    async function sendMessage(messageOverride) {
      const message = (messageOverride ?? inputEl.value).trim();
      const userId = userIdEl.value.trim() || "default_user";
      if (!message) return;

      const normalizedInput = message.toLowerCase();
      if (["hi", "hello", "hey"].includes(normalizedInput)) {
        clearOptions();
      }

      addMessage(message, "user");
      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;
      document.getElementById("charCount").textContent = "0/300";
      showTyping();

      try {
        console.log("Sending message to /chat:", {
          message,
          user_id: userId,
          business_id: CHATBOT_CONFIG.businessId
        });
        
        // Use absolute URL if opened via file:// protocol
        const chatUrl = window.location.protocol === 'file:' 
          ? `http://localhost:8000/chat`
          : `/chat`;
        
        const res = await fetch(chatUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            user_id: userId,
            business_id: CHATBOT_CONFIG.businessId,
            system_prompt: buildBusinessSystemPrompt(),
            appointment_link: CHATBOT_CONFIG.appointmentLink,
          }),
        });
        
        console.log("Response status:", res.status, res.statusText);
        
        // Check if response is OK
        if (!res.ok) {
          const errorText = await res.text();
          console.error("API Error:", res.status, errorText);
          throw new Error(`Server error: ${res.status} - ${errorText.substring(0, 100)}`);
        }
        
        const data = await res.json();
        console.log("Response data:", data);
        const text = data.response || JSON.stringify(data);

        // If the bot lists options in text, keep only the first line for display
        let displayText = text;
        if (text.toLowerCase().includes("please choose one of the options below")) {
          const parts = text.split(/<br>|\\n/).map(p => p.trim()).filter(Boolean);
          if (parts.length) displayText = parts[0];
        }

        hideTyping();
        addMessage(displayText, "bot");

        // If the bot is prompting with main options, render chips inline in chat
        const normalized = text.toLowerCase();
        const hasPrimary = ["book an appointment", "speak to sales", "send more information"].every(t => normalized.includes(t));
        if (hasPrimary && !primaryRendered) {
          addOptionChips(primaryOptions, "primary");
        }
      } catch (err) {
        hideTyping();
        console.error("Chat error:", err);
        let errorMsg = "Error connecting to the assistant. Please try again.";
        if (err.message) {
          errorMsg += ` (${err.message})`;
        }
        addMessage(errorMsg, "error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", () => sendMessage());
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    inputEl.addEventListener("input", () => {
      const text = inputEl.value;
      const max = 300;
      const trimmed = text.slice(0, max);
      if (trimmed !== text) {
        inputEl.value = trimmed;
      }
      const current = inputEl.value.trim().length;
      document.getElementById("charCount").textContent = `${current}/${max}`;
      sendBtn.disabled = current === 0;
    });

    // Show privacy + greeting based on config so each client feels customized
    // Wait for config to load, then show initial messages
    async function initializeChat() {
      await loadBusinessConfig(); // Ensure config is loaded
      updateBusinessBranding(); // Update branding from config
      
      if (CHATBOT_CONFIG.privacyStatement) {
        addMessage(CHATBOT_CONFIG.privacyStatement, "meta");
      }
      const initialGreeting =
        CHATBOT_CONFIG.greetingMessage ||
        "Hi! I'm your AI assistant. Ask anything about services, pricing or booking and I'll guide you.";
      addMessage(initialGreeting, "bot");
    }
    
    // Initialize chat after page loads
    initializeChat();
  </script>
</body>
</html>

