<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GoAccel - Business Configuration</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fb;
      min-height: 100vh;
      padding: 0;
      margin: 0;
      color: #333;
    }
    .container {
      width: 100%;
      max-width: 100%;
      margin: 0;
      background: white;
      border-radius: 0;
      box-shadow: none;
      overflow: visible;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 40px;
      text-align: left;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header h1 { font-size: 28px; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .header-actions {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .btn-icon {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    .content {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 24px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }
    .required { color: #ef4444; }
    input[type="text"],
    input[type="email"],
    input[type="url"],
    input[type="color"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    input[type="file"] {
      padding: 8px;
      cursor: pointer;
    }
    input[type="file"]::-webkit-file-upload-button {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 12px;
    }
    input[type="file"]::-webkit-file-upload-button:hover {
      opacity: 0.9;
    }
    input:focus, textarea:focus, select:focus, input[type="file"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
    }
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .hidden { display: none; }
    .preview-section {
      margin-top: 40px;
      padding-top: 40px;
      border-top: 2px solid #e5e7eb;
      width: 100%;
    }
    .preview-section h2 {
      margin-bottom: 20px;
      color: #374151;
    }
    .code-block {
      background: #1f2937;
      color: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      line-height: 1.6;
    }
    .business-list {
      margin-top: 20px;
    }
    .business-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .business-logo-container {
      width: 48px;
      height: 48px;
      min-width: 48px;
      min-height: 48px;
      border-radius: 8px;
      overflow: hidden;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e5e7eb;
    }
    .business-logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 4px;
    }
    .business-logo-placeholder {
      width: 100%;
      height: 100%;
      background: transparent;
    }
    .business-card h3 {
      font-size: 16px;
      color: #111827;
      margin-bottom: 4px;
    }
    .business-card p {
      font-size: 12px;
      color: #6b7280;
    }
    .business-actions {
      display: flex;
      gap: 8px;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .btn-info {
      background: #06b6d4;
      color: white;
    }
    .btn-info:hover {
      background: #0891b2;
    }
    
    /* Scraping Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal h2 {
      margin: 0 0 16px 0;
      color: #1f2937;
    }
    .modal p {
      color: #6b7280;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .modal-status {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
    }
    .modal-message {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .btn-close {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-close:hover {
      background: #e5e7eb;
    }
    .modal-large {
      max-width: 1200px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-large .modal-content {
      padding: 0;
    }
    .delete-modal .modal {
      max-width: 450px;
    }
    .delete-modal .modal h2 {
      color: #ef4444;
    }
    .delete-modal .modal-actions {
      justify-content: flex-end;
    }
    #adminApiKey:focus {
      outline: none;
      border-color: #667eea !important;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }
    .category-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      background: white;
      transition: all 0.2s ease;
    }
    .category-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .category-card.category-enabled {
      border-color: #2563eb;
      background: #eff6ff;
    }
    #categorySearch:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-actions">
        <button class="btn-icon" onclick="toggleSettingsModal()" title="Settings">
          ‚öôÔ∏è
        </button>
      </div>
      <h1>ü§ñ GoAccel Configuration</h1>
      <p>Configure your business chatbot settings</p>
    </div>
    
    <div class="content">
      <div id="alertContainer"></div>
      
      <!-- Action Buttons -->
      <div style="margin-bottom: 24px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button id="toggleFormBtn" class="btn btn-primary" onclick="toggleForm()">
          ‚ûï Create New Business
        </button>
        <button class="btn btn-secondary" onclick="loadBusinesses()">
          üìã View All Businesses
        </button>
      </div>
      
      <!-- Business Form Modal -->
      <div id="businessFormModal" class="modal-overlay">
        <div class="modal modal-large">
          <div style="padding: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2 style="margin: 0;">ü§ñ Business Configuration</h2>
              <button class="btn btn-close" onclick="toggleForm()" style="padding: 8px 16px;">‚úï Close</button>
            </div>
            <form id="businessForm">
        <!-- Basic Information Section -->
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="margin-bottom: 20px; color: #374151; font-size: 18px;">üìã Basic Information</h3>
          
          <div class="form-group">
            <label>Business ID <span class="required">*</span></label>
            <input type="text" id="businessId" name="businessId" required 
                   placeholder="e.g., my-company-123" />
            <div class="help-text">Unique identifier for your business (used in API calls)</div>
          </div>
          
          <div class="form-group">
            <label>Business Name <span class="required">*</span></label>
            <input type="text" id="businessName" name="businessName" required 
                   placeholder="e.g., My Company" />
          </div>
          
          <div class="form-group">
            <label>System Prompt / Instructions <span class="required">*</span></label>
            <textarea id="systemPrompt" name="systemPrompt" required
                      placeholder="Describe your business, services, products, and how the chatbot should behave. Be specific about what information to share and how to interact with customers."></textarea>
            <div class="help-text">This is the main customization - describe your business, services, and chatbot behavior</div>
          </div>
        </div>

        <!-- Branding & Appearance Section -->
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="margin-bottom: 20px; color: #374151; font-size: 18px;">üé® Branding & Appearance</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Theme Color</label>
              <input type="color" id="themeColor" name="themeColor" value="#2563eb" />
            </div>
            
            <div class="form-group">
              <label>Widget Position</label>
              <select id="widgetPosition" name="widgetPosition">
                <option value="center">Center</option>
                <option value="bottom-right">Bottom Right</option>
                <option value="bottom-left">Bottom Left</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Chatbot Button Text</label>
            <input type="text" id="chatbotButtonText" name="chatbotButtonText" 
                   placeholder="e.g., Chat with us" />
            <div class="help-text">Text displayed on the chatbot button/widget</div>
          </div>
          
          <div class="form-group">
            <label>Business Logo</label>
            <input type="file" id="businessLogoFile" accept="image/*" 
                   style="margin-bottom: 8px;" />
            <div class="help-text">Upload your business logo image (PNG, JPG, SVG, etc.) - Max 2MB</div>
            <div id="logoPreview" style="margin-top: 12px; display: none;">
              <img id="logoPreviewImg" src="" alt="Logo preview" style="max-width: 200px; max-height: 100px; border: 2px solid #e5e7eb; border-radius: 8px; padding: 8px; background: #f9fafb;" />
              <div style="margin-top: 8px;">
                <button type="button" class="btn btn-secondary btn-small" onclick="clearLogo()">Remove Logo</button>
              </div>
            </div>
            <input type="hidden" id="businessLogo" name="businessLogo" />
          </div>
        </div>

        <!-- Messaging & Personality Section -->
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="margin-bottom: 20px; color: #374151; font-size: 18px;">üí¨ Messaging & Personality</h3>
          
          <div class="form-group">
            <label>Greeting Message</label>
            <input type="text" id="greetingMessage" name="greetingMessage" 
                   placeholder="e.g., Hi! How can we help you today?" />
            <div class="help-text">Initial message shown when chat opens</div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Primary Goal</label>
              <input type="text" id="primaryGoal" name="primaryGoal" 
                     placeholder="e.g., Generate more leads" />
            </div>
            
            <div class="form-group">
              <label>Personality</label>
              <input type="text" id="personality" name="personality" 
                     placeholder="e.g., Friendly and professional" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Privacy Statement</label>
            <textarea id="privacyStatement" name="privacyStatement"
                      placeholder="We collect your information only to provide better service..."></textarea>
            <div class="help-text">Shown when collecting customer information</div>
          </div>
        </div>

        <!-- Contact Information Section -->
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="margin-bottom: 20px; color: #374151; font-size: 18px;">üìû Contact Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Website URL</label>
              <input type="url" id="websiteUrl" name="websiteUrl" 
                     placeholder="https://example.com" />
            </div>
            
            <div class="form-group">
              <label>Contact Email</label>
              <input type="email" id="contactEmail" name="contactEmail" 
                     placeholder="contact@example.com" />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Contact Phone</label>
              <input type="text" id="contactPhone" name="contactPhone" 
                     placeholder="+1 (555) 123-4567" />
            </div>
            
            <!-- Appointment/Booking Link removed - use CTA Tree with redirect action instead -->
            <!-- Example CTA: {"appt_growth_call": {"id": "appt_growth_call", "label": "15-Min Growth Call", "action": "redirect", "url": "https://calendly.com/goaccel/growth-call"}} -->
          </div>
        </div>

        <!-- Call-to-Actions Section -->
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="margin-bottom: 20px; color: #374151; font-size: 18px;">üîò Call-to-Actions (CTAs)</h3>
          
          <div class="form-group">
            <label>CTA Tree (JSON) - Tree-based Structure</label>
            <textarea id="ctaTree" name="ctaTree" style="min-height: 300px; font-family: monospace;"
                      placeholder='{"learn_services": {"id": "learn_services", "label": "Learn About Services", "action": "show_children", "children": ["digital_agency", "website_design"]}, ...}'></textarea>
            <div class="help-text">
              <strong>Tree-based CTA structure.</strong> Each CTA has: id, label, action (show_children/redirect/send), children (array of child IDs), url (if redirect), message (if send).
              See team lead's document for complete example.
            </div>
          </div>
        </div>

        <!-- Features Section -->
        <div style="margin-bottom: 32px;">
          <h3 style="margin-bottom: 20px; color: #374151; font-size: 18px;">‚öôÔ∏è Features</h3>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="voiceEnabled" name="voiceEnabled" value="true" />
              Enable Voice Bot (Phone Calls)
            </label>
            <div class="help-text">Check this to enable phone call functionality for this business. Not all tenants need voice capabilities.</div>
          </div>
        </div>
        
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
          <button type="button" class="btn btn-secondary" onclick="loadGoAccelTemplate()">üöÄ Load GoAccel Template</button>
          <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ Clear Form</button>
        </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="preview-section">
        <h2>üìã Configured Businesses</h2>
        <div id="businessList" class="business-list"></div>
      </div>
      
      <div class="preview-section">
        <h2>üîó Integration Code</h2>
        <p style="margin-bottom: 12px; color: #6b7280;">Use this code in your website to embed the chatbot:</p>
        <div class="code-block" id="integrationCode">
          &lt;script&gt;
            const CHATBOT_CONFIG = {
              businessId: "<span id="code_business_id">your-business-id</span>"
            };
          &lt;/script&gt;
          &lt;iframe src="${API_BASE}/?business_id=<span id="code_business_id2">your-business-id</span>" 
                   style="width: 440px; height: 600px; border: none;"&gt;&lt;/iframe&gt;
        </div>
      </div>
    </div>
  </div>

  <!-- Scraping Progress Modal -->
  <div id="scrapingModal" class="modal-overlay">
    <div class="modal" style="max-width: 800px;">
      <h2>üåê Building Knowledge Base</h2>
      <div class="modal-status" id="modalStatus">Initializing...</div>
      <div class="modal-message" id="modalMessage">Preparing to scrape your website...</div>
      <div style="margin: 12px 0; font-size: 12px; color: #9ca3af;" id="progressDetails">
        <!-- Progress details will be shown here -->
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <!-- Categories Section -->
      <div id="categoriesSection" style="display: none; margin-top: 32px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 18px;">üìÅ Page Categories</h3>
          <div id="categoriesSummary" style="font-size: 14px; color: #6b7280; margin-bottom: 16px;"></div>
          
          <!-- Bulk Actions -->
          <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
            <button class="btn btn-secondary btn-small" onclick="selectAllCategories()" style="font-size: 12px; padding: 6px 12px;">
              ‚úì Select All
            </button>
            <button class="btn btn-secondary btn-small" onclick="deselectAllCategories()" style="font-size: 12px; padding: 6px 12px;">
              ‚úó Deselect All
            </button>
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="categorySearch" placeholder="üîç Search categories..." 
                     style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;"
                     oninput="filterCategories(this.value)">
            </div>
          </div>
        </div>
        
        <div id="categoriesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px;">
          <!-- Categories will be dynamically inserted here -->
        </div>
        
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <div style="font-size: 13px; color: #6b7280;">
            <span id="categoryStats">0 selected</span> of <span id="totalCategories">0</span> categories
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary btn-small" onclick="closeScrapingModal()" style="font-size: 13px; padding: 8px 16px;">
              Cancel
            </button>
            <button class="btn btn-primary" onclick="saveEnabledCategories()" id="saveCategoriesBtn" style="display: none; font-size: 14px; padding: 10px 20px;">
              üíæ Save Category Selection
            </button>
          </div>
        </div>
      </div>
      
      <!-- Modal Actions (only shown when categories section is hidden) -->
      <div class="modal-actions" id="modalActionsDefault" style="margin-top: 24px;">
        <button class="btn btn-close" onclick="closeScrapingModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay delete-modal">
    <div class="modal">
      <h2>‚ö†Ô∏è Delete Business</h2>
      <p id="deleteModalMessage">Are you sure you want to delete this business? This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn btn-close" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="modal-overlay">
    <div class="modal">
      <h2 style="color: #dc2626;">‚ùå Error</h2>
      <p id="errorModalMessage" style="color: #374151; line-height: 1.6;"></p>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeErrorModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">‚öôÔ∏è Settings</h2>
        <button class="btn btn-close" onclick="toggleSettingsModal()" style="padding: 8px 16px;">‚úï Close</button>
      </div>
      
      <div class="form-group">
        <label>Admin API Key <span class="required">*</span></label>
        <input type="password" id="adminApiKey" placeholder="Enter your Admin API Key" 
               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s;" />
        <div class="help-text">
          Enter the Admin API Key from your <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 11px;">.env</code> file. 
          This key is required to access the configuration panel and manage businesses.
        </div>
      </div>
      
      <div class="modal-actions" style="margin-top: 24px;">
        <button class="btn btn-primary" onclick="toggleSettingsModal()">Save & Close</button>
      </div>
    </div>
  </div>

  <script>
    // Detects the current origin or defaults to localhost (port 80)
    const API_BASE = window.location.protocol === 'file:' 
      ? 'http://localhost:8000'
      : window.location.origin;
    
    // Handle logo file upload and convert to base64
    document.getElementById('businessLogoFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        clearLogo();
        return;
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showAlert('Please select an image file (PNG, JPG, SVG, etc.)', 'error');
        e.target.value = '';
        return;
      }
      
      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showAlert('Image file size must be less than 2MB', 'error');
        e.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const base64 = event.target.result;
        document.getElementById('businessLogo').value = base64;
        
        // Show preview
        const preview = document.getElementById('logoPreview');
        const previewImg = document.getElementById('logoPreviewImg');
        previewImg.src = base64;
        preview.style.display = 'block';
      };
      reader.onerror = function() {
        showAlert('Error reading file. Please try again.', 'error');
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    });
    
    // Clear logo function
    function clearLogo() {
      document.getElementById('businessLogoFile').value = '';
      document.getElementById('businessLogo').value = '';
      document.getElementById('logoPreview').style.display = 'none';
    }

    // Admin API Key - Get from localStorage or input field
    let ADMIN_API_KEY = localStorage.getItem('admin_api_key');
    
    // Function to get API key from input field
    function getApiKeyFromInput() {
      const input = document.getElementById('adminApiKey');
      if (input && input.value) {
        ADMIN_API_KEY = input.value;
        localStorage.setItem('admin_api_key', input.value);
        return input.value;
      }
      return ADMIN_API_KEY;
    }
    
    // Update API key when input changes
    document.getElementById('adminApiKey').addEventListener('input', function(e) {
      if (e.target.value) {
        ADMIN_API_KEY = e.target.value;
        localStorage.setItem('admin_api_key', e.target.value);
      }
    });
    
    // Load API key from localStorage into input field
    if (ADMIN_API_KEY) {
      document.getElementById('adminApiKey').value = ADMIN_API_KEY;
    }
    
    // Helper function to get headers with API key
    function getAdminHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const apiKey = getApiKeyFromInput();
      if (apiKey) {
        headers['X-Admin-API-Key'] = apiKey;
      }
      return headers;
    }
    
    // Function to show error if API key is missing
    function requireApiKey() {
      const apiKey = getApiKeyFromInput();
      if (!apiKey) {
        showAlert('Please enter your Admin API Key in the field above.', 'error');
        document.getElementById('adminApiKey').focus();
        return false;
      }
      return true;
    }

    // Update integration code display with dynamic API_BASE
    function updateIntegrationCodeOnLoad() {
      const integrationCodeEl = document.getElementById('integrationCode');
      if (integrationCodeEl) {
        updateIntegrationCode('your-business-id');
      }
    }

    
    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
    
    function clearForm() {
      document.getElementById('businessForm').reset();
      document.getElementById('themeColor').value = '#2563eb';
      clearLogo();
    }
    
    function loadGoAccelTemplate() {
      // Fill all fields with GoAccel default values
      document.getElementById('businessId').value = 'goaccel-website';
      document.getElementById('businessName').value = 'GoAccel';
      document.getElementById('systemPrompt').value = `GoAccel is an all-in-one growth and operations system built specifically for home services and skilled trade businesses. We combine customer acquisition, automation, CRM, scheduling, and operational systems into a single platform designed to help owners scale predictably and build long-term enterprise value.

Our services include:
- Digital Agency Solutions: Full-service digital agency/lead gen services including websites, paid ads, and conversion tracking
- CRM Software: Customer relationship management, deal pipeline management, business management software
- Marketing Automation: Automated appointment booking, lead nurturing, marketing campaign management
- Business Listing Management: Customer review management, data enhancement, database reactivation

We serve industries including HVAC, plumbing, electrical, window cleaning, appliance repair, carpet cleaning, handyman, cleaning & janitorial, garage door, lawn care, pest control, custom home building, pool & spa service, fireplace & chimney, custom remodeling, locksmith, landscaping, painting contractors, junk removal, property maintenance, roofing, and mechanic services.

Your role is to help potential customers understand how GoAccel can help their home services business grow. Be friendly, knowledgeable, and focus on how we can help them achieve predictable growth and build business value.`;
      
      document.getElementById('primaryGoal').value = 'Help home services businesses scale predictably and build long-term enterprise value';
      document.getElementById('personality').value = 'Friendly, knowledgeable, and growth-focused';
      document.getElementById('greetingMessage').value = 'Hi! Welcome to GoAccel. I\'m here to help you understand how we can accelerate your home services business growth. What would you like to know?';
      // appointmentLink removed - use CTA tree with redirect action instead
      document.getElementById('privacyStatement').value = 'We collect your information only to provide better service and connect you with the right solutions for your business. Your data is secure and will not be shared with third parties.';
      document.getElementById('websiteUrl').value = 'https://warmprospect.com/goaccel-website/';
      document.getElementById('contactEmail').value = 'info@goaccel.com';
      document.getElementById('contactPhone').value = '855.915.0747';
      document.getElementById('chatbotButtonText').value = 'Chat with us';
      clearLogo();
      document.getElementById('themeColor').value = '#667eea';
      document.getElementById('widgetPosition').value = 'center';
      
      
      // Update integration code
      updateIntegrationCode('goaccel-website');
      
      showAlert('‚úÖ GoAccel template loaded! Review and customize the fields, then click "Save Configuration".', 'success');
    }
    
    async function loadBusinesses() {
      if (!requireApiKey()) return;
      
      try {
        console.log('Loading businesses from:', `${API_BASE}/admin/business`);
        const res = await fetch(`${API_BASE}/admin/business`, {
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            // API key issue - clear and show error
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        console.log('Businesses loaded:', data);
        
        const listEl = document.getElementById('businessList');
        if (!data.businesses || Object.keys(data.businesses).length === 0) {
          listEl.innerHTML = '<p style="color: #6b7280;">No businesses configured yet.</p>';
          return;
        }
        
        listEl.innerHTML = Object.values(data.businesses).map(business => `
          <div class="business-card">
            <div style="display: flex; align-items: center; gap: 16px;">
              <div class="business-logo-container">
                ${business.businessLogo ? 
                  `<img src="${business.businessLogo}" alt="${business.businessName || business.businessId} logo" class="business-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : 
                  ''
                }
                <div class="business-logo-placeholder" style="display: ${business.businessLogo ? 'none' : 'block'};">
                  <!-- Blank placeholder - no content -->
                </div>
              </div>
              <div>
                <h3>${business.businessName || business.businessId}</h3>
                <p>ID: ${business.businessId} ‚Ä¢ Updated: ${new Date(business.updatedAt || business.updated_at).toLocaleString()}</p>
              </div>
            </div>
            <div class="business-actions">
              <button class="btn btn-secondary btn-small" onclick="loadBusiness('${business.businessId}')">Edit</button>
              ${business.websiteUrl ? `<button class="btn btn-info btn-small" onclick="triggerScraping('${business.businessId}')" title="Build Knowledge Base from ${business.websiteUrl}">üåê Build KB</button>` : ''}
              <a href="${API_BASE}/bot?business_id=${business.businessId}" target="_blank" class="btn btn-primary btn-small" style="text-decoration: none; display: inline-block;">üí¨ Test Chatbot</a>
              <button class="btn btn-danger btn-small" onclick="showDeleteModal('${business.businessId}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading businesses:', err);
        showAlert('Failed to load businesses: ' + err.message, 'error');
      }
    }
    
    async function loadBusiness(businessId) {
      if (!requireApiKey()) return;
      
      try {
        console.log('Loading business:', businessId);
        const res = await fetch(`${API_BASE}/admin/business/${businessId}`, {
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        const config = data.config;
        console.log('Business config loaded:', config);
        
        // Populate form - using camelCase from API
        document.getElementById('businessId').value = config.businessId || '';
        document.getElementById('businessName').value = config.businessName || '';
        document.getElementById('systemPrompt').value = config.systemPrompt || '';
        document.getElementById('primaryGoal').value = config.primaryGoal || '';
        document.getElementById('personality').value = config.personality || '';
        document.getElementById('greetingMessage').value = config.greetingMessage || '';
        // appointmentLink removed - use CTA tree with redirect action instead
        document.getElementById('privacyStatement').value = config.privacyStatement || '';
        document.getElementById('themeColor').value = config.themeColor || '#2563eb';
        document.getElementById('widgetPosition').value = config.widgetPosition || 'center';
        document.getElementById('websiteUrl').value = config.websiteUrl || '';
        document.getElementById('contactEmail').value = config.contactEmail || '';
        document.getElementById('contactPhone').value = config.contactPhone || '';
        document.getElementById('chatbotButtonText').value = config.chatbotButtonText || '';
        
        // Handle logo (base64 or URL)
        const logoValue = config.businessLogo || '';
        if (logoValue) {
          document.getElementById('businessLogo').value = logoValue;
          // If it's base64 (starts with data:), show preview
          if (logoValue.startsWith('data:image/')) {
            const preview = document.getElementById('logoPreview');
            const previewImg = document.getElementById('logoPreviewImg');
            previewImg.src = logoValue;
            preview.style.display = 'block';
          }
        } else {
          clearLogo();
        }
        
        // Load CTA tree if available
        document.getElementById('ctaTree').value = JSON.stringify(
          config.ctaTree || {},
          null,
          2
        );
        
        // Update integration code
        updateIntegrationCode(config.businessId);
        
        // Load voiceEnabled checkbox
        document.getElementById('voiceEnabled').checked = config.voiceEnabled || false;
        
        // Show form modal when editing
        const modal = document.getElementById('businessFormModal');
        const btn = document.getElementById('toggleFormBtn');
        modal.classList.add('active');
        btn.textContent = '‚ùå Cancel';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        
        showAlert('Business configuration loaded! <a href="' + API_BASE + '/bot?business_id=' + (config.businessId || businessId) + '" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">Test Your Chatbot ‚Üí</a>', 'success');
      } catch (err) {
        console.error('Error loading business:', err);
        showAlert('Failed to load business: ' + err.message, 'error');
      }
    }
    
    let pendingDeleteBusinessId = null;
    
    function showDeleteModal(businessId) {
      pendingDeleteBusinessId = businessId;
      const modal = document.getElementById('deleteModal');
      const messageEl = document.getElementById('deleteModalMessage');
      messageEl.textContent = `Are you sure you want to delete business "${businessId}"? This action cannot be undone.`;
      modal.classList.add('active');
    }
    
    function closeDeleteModal() {
      const modal = document.getElementById('deleteModal');
      modal.classList.remove('active');
      pendingDeleteBusinessId = null;
    }
    
    // Error Modal Functions
    function showErrorModal(message) {
      const modal = document.getElementById('errorModal');
      const messageEl = document.getElementById('errorModalMessage');
      // Replace newlines with <br> tags for proper display
      messageEl.innerHTML = message.replace(/\n/g, '<br>');
      modal.classList.add('active');
    }
    
    function closeErrorModal() {
      const modal = document.getElementById('errorModal');
      modal.classList.remove('active');
    }
    
    async function confirmDelete() {
      if (!pendingDeleteBusinessId) return;
      
      if (!requireApiKey()) {
        closeDeleteModal();
        return;
      }
      
      const businessId = pendingDeleteBusinessId;
      closeDeleteModal();
      
      try {
        console.log('Deleting business:', businessId);
        const res = await fetch(`${API_BASE}/admin/business/${businessId}`, {
          method: 'DELETE',
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        console.log('Delete response:', data);
        
        if (data.success) {
          showAlert('Business deleted successfully!', 'success');
          loadBusinesses();
        } else {
          showAlert('Failed to delete: ' + (data.detail || 'Unknown error'), 'error');
        }
      } catch (err) {
        console.error('Error deleting business:', err);
        showAlert('Failed to delete business: ' + err.message, 'error');
      }
    }
    
    function updateIntegrationCode(businessId) {
      const integrationCodeEl = document.getElementById('integrationCode');
      const safeBusinessId = businessId.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      integrationCodeEl.innerHTML = `
&lt;script&gt;
  const CHATBOT_CONFIG = {
    businessId: "${safeBusinessId}"
  };
&lt;/script&gt;
&lt;iframe src="${API_BASE}/bot?business_id=${safeBusinessId}" 
         style="width: 440px; height: 600px; border: none;"&gt;&lt;/iframe&gt;
      `.trim();
    }
    
    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!requireApiKey()) return;
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      let ctaTree = {};
      try {
        if (data.ctaTree && data.ctaTree.trim()) {
          ctaTree = JSON.parse(data.ctaTree);
        }
      } catch (err) {
        showErrorModal('CTA Tree must be valid JSON. Please check the format and try again.');
        return;
      }
      data.ctaTree = ctaTree;
      data.voiceEnabled = data.voiceEnabled === 'true' || data.voiceEnabled === true;
      
      // Validate required fields
      if (!data.businessId || !data.businessName || !data.systemPrompt) {
        showErrorModal('Please fill in all required fields:\n\n‚Ä¢ Business ID\n‚Ä¢ Business Name\n‚Ä¢ System Prompt');
        return;
      }
      
      try {
        console.log('Saving business:', data.businessId);
        const res = await fetch(`${API_BASE}/admin/business`, {
          method: 'POST',
          headers: getAdminHeaders(),
          body: JSON.stringify(data)
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorMessage = '';
          
          if (res.status === 403 || res.status === 500) {
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            errorMessage = 'Invalid or missing API key. Please enter a valid Admin API Key.';
            document.getElementById('adminApiKey').focus();
            showErrorModal(errorMessage);
            return;
          }
          
          // Try to parse error JSON
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.detail || errorJson.message || errorText;
          } catch {
            errorMessage = errorText || `HTTP ${res.status}: ${res.statusText}`;
          }
          
          showErrorModal(errorMessage);
          return;
        }
        
        const result = await res.json();
        console.log('Save response:', result);
        
        if (result.success) {
          updateIntegrationCode(data.businessId);
          loadBusinesses();
          
          showAlert('‚úÖ Configuration saved successfully! Your chatbot is ready. <a href="' + API_BASE + '/bot?business_id=' + data.businessId + '" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">Test Chatbot ‚Üí</a>', 'success');
          // Hide form after successful save
          toggleForm();
        } else {
          const errorMsg = result.detail || result.message || 'Unknown error occurred';
          showErrorModal('Failed to save configuration:\n\n' + errorMsg);
        }
      } catch (err) {
        console.error('Error saving business:', err);
        showErrorModal('An error occurred while saving:\n\n' + err.message);
      }
    });
    
    // Update integration code when businessId changes
    document.getElementById('businessId').addEventListener('input', (e) => {
      updateIntegrationCode(e.target.value || 'your-business-id');
    });
    
    // Scraping Modal Functions
    function showScrapingModal(businessId) {
      const modal = document.getElementById('scrapingModal');
      modal.classList.add('active');
      updateScrapingStatus(businessId);
    }
    
    function closeScrapingModal() {
      const modal = document.getElementById('scrapingModal');
      modal.classList.remove('active');
      
      // Reset category section
      const categoriesSection = document.getElementById('categoriesSection');
      if (categoriesSection) {
        categoriesSection.style.display = 'none';
      }
      
      // Reset search
      const searchInput = document.getElementById('categorySearch');
      if (searchInput) {
        searchInput.value = '';
        filterCategories('');
      }
      
      // Show default modal actions
      const defaultActions = document.getElementById('modalActionsDefault');
      if (defaultActions) defaultActions.style.display = 'flex';
      
      // Stop polling
      if (scrapingPollInterval) {
        clearInterval(scrapingPollInterval);
        scrapingPollInterval = null;
      }
      
      // Reset tracking variables
      lastProgress = -1;
      lastProgressTime = null;
      lastStatus = null;
      stuckWarningShown = false;
      currentCategories = [];
    }
    
    let currentBusinessId = null;
    let currentCategories = [];
    let lastProgress = -1;
    let lastProgressTime = null;
    let lastStatus = null;
    let stuckWarningShown = false;
    
    function updateScrapingStatus(businessId) {
      currentBusinessId = businessId;
      fetch(`${API_BASE}/admin/business/${businessId}/scraping-status`, {
        headers: getAdminHeaders()
      })
        .then(res => res.json())
        .then(status => {
          const statusEl = document.getElementById('modalStatus');
          const messageEl = document.getElementById('modalMessage');
          const progressEl = document.getElementById('progressFill');
          const categoriesSection = document.getElementById('categoriesSection');
          const categoriesGrid = document.getElementById('categoriesGrid');
          const categoriesSummary = document.getElementById('categoriesSummary');
          
          // Detect if scraping is stuck
          const currentProgress = status.progress || 0;
          const currentStatus = status.status;
          const now = Date.now();
          
          // Check if progress hasn't changed in 5 minutes (300000ms)
          if (lastProgress === currentProgress && lastStatus === currentStatus && 
              lastProgressTime && (now - lastProgressTime) > 300000 && 
              currentStatus !== 'completed' && currentStatus !== 'failed') {
            if (!stuckWarningShown) {
              stuckWarningShown = true;
              const stuckMinutes = Math.floor((now - lastProgressTime) / 60000);
              messageEl.innerHTML = `
                <div style="color: #dc2626; font-weight: 600; margin-bottom: 8px;">
                  ‚ö†Ô∏è Scraping appears to be stuck (no progress for ${stuckMinutes} minutes)
                </div>
                <div style="color: #6b7280; font-size: 13px;">
                  ${status.message || 'The scraping process may have encountered an issue.'}
                </div>
                <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e;">
                  <strong>üí° Troubleshooting:</strong><br>
                  ‚Ä¢ Check server logs: <code>sudo journalctl -u goaccel.service -f</code><br>
                  ‚Ä¢ The process may be waiting for a slow website response<br>
                  ‚Ä¢ Try refreshing the knowledge base if it continues to be stuck
                </div>
              `;
              statusEl.style.color = '#dc2626';
            }
          } else {
            // Progress is updating, reset warning
            if (currentProgress !== lastProgress || currentStatus !== lastStatus) {
              stuckWarningShown = false;
              lastProgress = currentProgress;
              lastStatus = currentStatus;
              lastProgressTime = now;
              statusEl.style.color = '';
            }
          }
          
          // Update last progress time if this is first check
          if (!lastProgressTime) {
            lastProgressTime = now;
          }
          
          let statusText = '';
          let messageText = status.message || '';
          let progress = currentProgress;
          
          // Add last updated timestamp if available
          if (status.updated_at) {
            const updatedTime = new Date(status.updated_at * 1000);
            const timeAgo = Math.floor((now - updatedTime.getTime()) / 1000);
            let timeAgoText = '';
            if (timeAgo < 60) {
              timeAgoText = `${timeAgo} seconds ago`;
            } else if (timeAgo < 3600) {
              timeAgoText = `${Math.floor(timeAgo / 60)} minutes ago`;
            } else {
              timeAgoText = `${Math.floor(timeAgo / 3600)} hours ago`;
            }
            messageText += ` <span style="color: #9ca3af; font-size: 12px;">(Updated ${timeAgoText})</span>`;
          }
          
          switch(status.status) {
            case 'pending':
              statusText = '‚è≥ Preparing...';
              break;
            case 'scraping':
              statusText = 'üåê Scraping Website...';
              progress = Math.max(progress, 20);
              break;
            case 'categorizing':
              statusText = 'üè∑Ô∏è Categorizing Pages...';
              progress = Math.max(progress, 40);
              break;
            case 'indexing':
              statusText = 'üìö Building Knowledge Base...';
              progress = Math.max(progress, 50);
              break;
            case 'completed':
              statusText = '‚úÖ Complete!';
              progress = 100;
              messageText = 'Your chatbot is now ready to use with the scraped knowledge base!';
              
              // Show categories if available
              if (status.categories && status.categories.length > 0) {
                currentCategories = status.categories;
                window.totalPages = status.total_pages || 0;
                displayCategories(status.categories, window.totalPages);
                categoriesSection.style.display = 'block';
                // Hide default modal actions when categories are shown
                const defaultActions = document.getElementById('modalActionsDefault');
                if (defaultActions) defaultActions.style.display = 'none';
              }
              
              // Don't auto-close, let user review categories
              return; // Continue polling to check for category updates
            case 'failed':
              statusText = '‚ùå Failed';
              messageText = status.message || 'Scraping failed. Please try again.';
              progress = 0;
              return; // Stop polling
            default:
              statusText = '‚è≥ Waiting...';
          }
          
          // Show categories if available (even during indexing)
          if (status.categories && status.categories.length > 0) {
            currentCategories = status.categories;
            window.totalPages = status.total_pages || 0;
            displayCategories(status.categories, window.totalPages);
            categoriesSection.style.display = 'block';
            // Hide default modal actions when categories are shown
            const defaultActions = document.getElementById('modalActionsDefault');
            if (defaultActions) defaultActions.style.display = 'none';
          } else {
            // Show default modal actions when categories are not shown
            const defaultActions = document.getElementById('modalActionsDefault');
            if (defaultActions) defaultActions.style.display = 'flex';
          }
          
          statusEl.textContent = statusText;
          messageEl.innerHTML = messageText;
          progressEl.style.width = progress + '%';
          
          // Update progress details
          const progressDetailsEl = document.getElementById('progressDetails');
          if (progressDetailsEl) {
            let detailsText = `Progress: ${progress}%`;
            if (scrapingStartTime) {
              const elapsed = Math.floor((Date.now() - scrapingStartTime) / 1000);
              const minutes = Math.floor(elapsed / 60);
              const seconds = elapsed % 60;
              detailsText += ` ‚Ä¢ Elapsed: ${minutes}m ${seconds}s`;
            }
            if (lastProgressTime && lastProgress !== -1) {
              const timeSinceUpdate = Math.floor((Date.now() - lastProgressTime) / 1000);
              if (timeSinceUpdate > 30) {
                detailsText += ` ‚Ä¢ <span style="color: #dc2626;">No update for ${Math.floor(timeSinceUpdate / 60)}m</span>`;
              }
            }
            progressDetailsEl.innerHTML = detailsText; // Use innerHTML instead of textContent
          }
        })
        .catch(err => {
          console.error('Error checking scraping status:', err);
          const statusEl = document.getElementById('modalStatus');
          const messageEl = document.getElementById('modalMessage');
          
          // Show network error warning
          statusEl.textContent = '‚ö†Ô∏è Connection Error';
          statusEl.style.color = '#dc2626';
          messageEl.innerHTML = `
            <div style="color: #dc2626; font-weight: 600; margin-bottom: 8px;">
              Failed to check scraping status
            </div>
            <div style="color: #6b7280; font-size: 13px;">
              ${err.message || 'Network error occurred. The scraping may still be running on the server.'}
            </div>
            <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e;">
              <strong>üí° Check server status:</strong><br>
              ‚Ä¢ Check if the server is running<br>
              ‚Ä¢ Verify API key is correct<br>
              ‚Ä¢ Check server logs: <code>sudo journalctl -u goaccel.service -f</code>
            </div>
          `;
        });
    }
    
    function displayCategories(categories, totalPages) {
      const categoriesGrid = document.getElementById('categoriesGrid');
      const categoriesSummary = document.getElementById('categoriesSummary');
      const totalCategoriesEl = document.getElementById('totalCategories');
      
      // Store original categories for filtering
      window.allCategories = categories;
      
      categoriesSummary.innerHTML = `
        <strong>${totalPages}</strong> pages were classified into <strong>${categories.length}</strong> categories. 
        Select which categories to include in your chatbot's knowledge base.
      `;
      
      totalCategoriesEl.textContent = categories.length;
      
      renderCategories(categories);
      updateCategoryStats();
      
      // Show save button
      document.getElementById('saveCategoriesBtn').style.display = 'inline-block';
    }
    
    function renderCategories(categories) {
      const categoriesGrid = document.getElementById('categoriesGrid');
      
      // Sort by page count (descending) then alphabetically
      const sortedCategories = [...categories].sort((a, b) => {
        if (b.page_count !== a.page_count) {
          return b.page_count - a.page_count;
        }
        return a.name.localeCompare(b.name);
      });
      
      categoriesGrid.innerHTML = sortedCategories.map(cat => {
        const enabledClass = cat.enabled ? 'category-enabled' : '';
        const percentage = Math.round((cat.page_count / (window.totalPages || 1)) * 100);
        
        return `
          <div class="category-card ${enabledClass}" data-category-name="${cat.name.toLowerCase()}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #111827; margin-bottom: 6px; font-size: 15px;">
                  ${cat.name}
                </div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                  ${cat.page_count} ${cat.page_count === 1 ? 'page' : 'pages'} (${percentage}%)
                </div>
                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: ${percentage}%; transition: width 0.3s;"></div>
                </div>
              </div>
            </div>
            <label style="position: relative; display: inline-flex; align-items: center; cursor: pointer; user-select: none;">
              <input type="checkbox" 
                     class="category-checkbox"
                     data-category="${cat.name}"
                     ${cat.enabled ? 'checked' : ''} 
                     onchange="toggleCategory('${cat.name}', this.checked); updateCategoryStats();"
                     style="opacity: 0; position: absolute; width: 0; height: 0;">
              <span style="position: relative; display: inline-block; width: 48px; height: 26px; background-color: ${cat.enabled ? '#2563eb' : '#d1d5db'}; border-radius: 26px; transition: all 0.3s ease; box-shadow: ${cat.enabled ? '0 0 0 2px rgba(37, 99, 235, 0.2)' : 'none'};">
                <span style="position: absolute; top: 2px; left: ${cat.enabled ? '24px' : '2px'}; width: 22px; height: 22px; background-color: white; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
              </span>
              <span style="margin-left: 10px; font-size: 13px; color: ${cat.enabled ? '#2563eb' : '#6b7280'}; font-weight: ${cat.enabled ? '600' : '400'};">
                ${cat.enabled ? 'Enabled' : 'Disabled'}
              </span>
            </label>
          </div>
        `;
      }).join('');
    }
    
    function updateCategoryStats() {
      const enabledCount = currentCategories.filter(c => c.enabled).length;
      const statsEl = document.getElementById('categoryStats');
      if (statsEl) {
        statsEl.textContent = `${enabledCount} selected`;
        statsEl.style.color = enabledCount > 0 ? '#2563eb' : '#6b7280';
        statsEl.style.fontWeight = enabledCount > 0 ? '600' : '400';
      }
    }
    
    function selectAllCategories() {
      currentCategories.forEach(cat => {
        cat.enabled = true;
      });
      document.querySelectorAll('.category-checkbox').forEach(cb => {
        cb.checked = true;
        const card = cb.closest('.category-card');
        if (card) {
          card.classList.add('category-enabled');
          const label = cb.nextElementSibling;
          if (label) {
            label.querySelector('span:first-child').style.backgroundColor = '#2563eb';
            label.querySelector('span:first-child').style.boxShadow = '0 0 0 2px rgba(37, 99, 235, 0.2)';
            const toggle = label.querySelector('span:last-child');
            if (toggle) {
              toggle.textContent = 'Enabled';
              toggle.style.color = '#2563eb';
              toggle.style.fontWeight = '600';
            }
            const thumb = label.querySelector('span:first-child > span');
            if (thumb) {
              thumb.style.left = '24px';
            }
          }
        }
      });
      updateCategoryStats();
    }
    
    function deselectAllCategories() {
      currentCategories.forEach(cat => {
        cat.enabled = false;
      });
      document.querySelectorAll('.category-checkbox').forEach(cb => {
        cb.checked = false;
        const card = cb.closest('.category-card');
        if (card) {
          card.classList.remove('category-enabled');
          const label = cb.nextElementSibling;
          if (label) {
            label.querySelector('span:first-child').style.backgroundColor = '#d1d5db';
            label.querySelector('span:first-child').style.boxShadow = 'none';
            const toggle = label.querySelector('span:last-child');
            if (toggle) {
              toggle.textContent = 'Disabled';
              toggle.style.color = '#6b7280';
              toggle.style.fontWeight = '400';
            }
            const thumb = label.querySelector('span:first-child > span');
            if (thumb) {
              thumb.style.left = '2px';
            }
          }
        }
      });
      updateCategoryStats();
    }
    
    function filterCategories(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const cards = document.querySelectorAll('.category-card');
      
      cards.forEach(card => {
        const categoryName = card.getAttribute('data-category-name');
        if (term === '' || categoryName.includes(term)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }
    
    function toggleCategory(categoryName, enabled) {
      // Update local state
      const category = currentCategories.find(c => c.name === categoryName);
      if (category) {
        category.enabled = enabled;
      }
      
      // Update visual state
      const checkbox = document.querySelector(`.category-checkbox[data-category="${categoryName}"]`);
      if (checkbox) {
        const card = checkbox.closest('.category-card');
        if (card) {
          if (enabled) {
            card.classList.add('category-enabled');
          } else {
            card.classList.remove('category-enabled');
          }
          
          const label = checkbox.nextElementSibling;
          if (label) {
            const toggleBg = label.querySelector('span:first-child');
            const toggleText = label.querySelector('span:last-child');
            const thumb = toggleBg.querySelector('span');
            
            if (enabled) {
              toggleBg.style.backgroundColor = '#2563eb';
              toggleBg.style.boxShadow = '0 0 0 2px rgba(37, 99, 235, 0.2)';
              if (toggleText) {
                toggleText.textContent = 'Enabled';
                toggleText.style.color = '#2563eb';
                toggleText.style.fontWeight = '600';
              }
              if (thumb) thumb.style.left = '24px';
            } else {
              toggleBg.style.backgroundColor = '#d1d5db';
              toggleBg.style.boxShadow = 'none';
              if (toggleText) {
                toggleText.textContent = 'Disabled';
                toggleText.style.color = '#6b7280';
                toggleText.style.fontWeight = '400';
              }
              if (thumb) thumb.style.left = '2px';
            }
          }
        }
      }
    }
    
    async function saveEnabledCategories() {
      if (!currentBusinessId || !requireApiKey()) return;
      
      const enabledCategories = currentCategories.filter(c => c.enabled).map(c => c.name);
      
      try {
        const res = await fetch(`${API_BASE}/admin/business/${currentBusinessId}/categories`, {
          method: 'POST',
          headers: {
            ...getAdminHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            enabled_categories: enabledCategories
          })
        });
        
        if (!res.ok) {
          throw new Error('Failed to save categories');
        }
        
        showAlert('‚úÖ Category selection saved! Your chatbot will only use content from enabled categories.', 'success');
        
        // Update current categories to reflect saved state
        currentCategories.forEach(cat => {
          cat.enabled = enabledCategories.includes(cat.name);
        });
        
        // Stop polling and close modal after a moment
        if (scrapingPollInterval) {
          clearInterval(scrapingPollInterval);
          scrapingPollInterval = null;
        }
        
        setTimeout(() => {
          closeScrapingModal();
        }, 2000);
      } catch (err) {
        console.error('Error saving categories:', err);
        showAlert('‚ùå Failed to save category selection: ' + err.message, 'error');
      }
    }
    
    let scrapingPollInterval = null;
    let scrapingStartTime = null;
    
    function startScrapingPoll(businessId) {
      // Clear any existing interval
      if (scrapingPollInterval) {
        clearInterval(scrapingPollInterval);
      }
      
      // Reset tracking variables
      lastProgress = -1;
      lastProgressTime = null;
      lastStatus = null;
      stuckWarningShown = false;
      scrapingStartTime = Date.now();
      
      // Poll every 2 seconds
      scrapingPollInterval = setInterval(() => {
        updateScrapingStatus(businessId);
        
        // Check for overall timeout (30 minutes)
        if (scrapingStartTime && (Date.now() - scrapingStartTime) > 30 * 60 * 1000) {
          const statusEl = document.getElementById('modalStatus');
          const messageEl = document.getElementById('modalMessage');
          statusEl.textContent = '‚è±Ô∏è Timeout';
          statusEl.style.color = '#dc2626';
          messageEl.innerHTML = `
            <div style="color: #dc2626; font-weight: 600; margin-bottom: 8px;">
              ‚ö†Ô∏è Scraping has been running for over 30 minutes
            </div>
            <div style="color: #6b7280; font-size: 13px;">
              The scraping process may have encountered an issue or the website is very large.
            </div>
            <div style="margin-top: 12px; padding: 12px; background: #fee2e2; border-radius: 6px; font-size: 13px; color: #991b1b;">
              <strong>üí° Recommended Actions:</strong><br>
              ‚Ä¢ Check server logs for errors<br>
              ‚Ä¢ The website might be too large - consider limiting pages<br>
              ‚Ä¢ Try refreshing the knowledge base
            </div>
          `;
          
          if (scrapingPollInterval) {
            clearInterval(scrapingPollInterval);
            scrapingPollInterval = null;
          }
        }
      }, 2000);
    }
    
    async function triggerScraping(businessId) {
      if (!requireApiKey()) return;
      
      try {
        const res = await fetch(`${API_BASE}/admin/business/${businessId}/scrape`, {
          method: 'POST',
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.detail || `HTTP ${res.status}`);
        }
        
        const result = await res.json();
        if (result.success) {
          showScrapingModal(businessId);
          startScrapingPoll(businessId);
          showAlert('üåê Knowledge base scraping started!', 'success');
        }
      } catch (err) {
        console.error('Error triggering scraping:', err);
        showAlert('‚ùå Failed to start scraping: ' + err.message, 'error');
      }
    }
    
    // Toggle form modal visibility
    function toggleForm() {
      const modal = document.getElementById('businessFormModal');
      const btn = document.getElementById('toggleFormBtn');
      if (modal.classList.contains('active')) {
        modal.classList.remove('active');
        btn.textContent = '‚ûï Create New Business';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        clearForm();
      } else {
        modal.classList.add('active');
        btn.textContent = '‚ùå Cancel';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      }
    }
    
    // Close form modal when clicking overlay
    document.getElementById('businessFormModal').addEventListener('click', function(e) {
      if (e.target === this) {
        toggleForm();
      }
    });
    
    // Toggle settings modal visibility
    function toggleSettingsModal() {
      const modal = document.getElementById('settingsModal');
      if (modal.classList.contains('active')) {
        modal.classList.remove('active');
      } else {
        modal.classList.add('active');
        // Focus on API key input when opening
        setTimeout(() => {
          document.getElementById('adminApiKey').focus();
        }, 100);
      }
    }
    
    // Close settings modal when clicking overlay
    document.getElementById('settingsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        toggleSettingsModal();
      }
    });
    
    // Set up delete confirmation button
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
    
    // Close delete modal when clicking overlay
    // Close error modal when clicking outside
    document.getElementById('errorModal').addEventListener('click', function(e) {
      if (e.target.id === 'errorModal') {
        closeErrorModal();
      }
    });
    
    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });
    
    // Load businesses on page load
    updateIntegrationCodeOnLoad();
    loadBusinesses();
  </script>
</body>
</html>

