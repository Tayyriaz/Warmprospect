<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GoAccel - Business Configuration</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 28px; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .content {
      padding: 40px;
    }
    .form-group {
      margin-bottom: 24px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }
    .required { color: #ef4444; }
    input[type="text"],
    input[type="email"],
    input[type="url"],
    input[type="color"],
    textarea,
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
    }
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .hidden { display: none; }
    .preview-section {
      margin-top: 40px;
      padding-top: 40px;
      border-top: 2px solid #e5e7eb;
    }
    .preview-section h2 {
      margin-bottom: 20px;
      color: #374151;
    }
    .code-block {
      background: #1f2937;
      color: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      line-height: 1.6;
    }
    .business-list {
      margin-top: 20px;
    }
    .business-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .business-card h3 {
      font-size: 16px;
      color: #111827;
      margin-bottom: 4px;
    }
    .business-card p {
      font-size: 12px;
      color: #6b7280;
    }
    .business-actions {
      display: flex;
      gap: 8px;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    
    /* Scraping Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal h2 {
      margin: 0 0 16px 0;
      color: #1f2937;
    }
    .modal p {
      color: #6b7280;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .modal-status {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
    }
    .modal-message {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .btn-close {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-close:hover {
      background: #e5e7eb;
    }
    .modal-large {
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-large .modal-content {
      padding: 0;
    }
    .delete-modal .modal {
      max-width: 450px;
    }
    .delete-modal .modal h2 {
      color: #ef4444;
    }
    .delete-modal .modal-actions {
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ GoAccel Configuration</h1>
      <p>Configure your business chatbot settings</p>
    </div>
    
    <div class="content">
      <div id="alertContainer"></div>
      
      <!-- Admin API Key Input -->
      <div class="form-group" style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 2px solid #e5e7eb;">
        <label>Admin API Key <span class="required">*</span></label>
        <input type="password" id="adminApiKey" placeholder="Enter Admin API Key from .env file" 
               style="margin-bottom: 8px;" />
        <div class="help-text">Enter your Admin API Key to access the configuration panel</div>
      </div>
      
      <!-- Toggle Form Button -->
      <div style="margin-bottom: 20px; text-align: center;">
        <button id="toggleFormBtn" class="btn btn-primary" onclick="toggleForm()">
          ‚ûï Create New Business
        </button>
      </div>
      
      <!-- Business Form Modal -->
      <div id="businessFormModal" class="modal-overlay">
        <div class="modal modal-large">
          <div style="padding: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2 style="margin: 0;">ü§ñ Business Configuration</h2>
              <button class="btn btn-close" onclick="toggleForm()" style="padding: 8px 16px;">‚úï Close</button>
            </div>
            <form id="businessForm">
        <div class="form-group">
          <label>Business ID <span class="required">*</span></label>
          <input type="text" id="business_id" name="business_id" required 
                 placeholder="e.g., my-company-123" />
          <div class="help-text">Unique identifier for your business (used in API calls)</div>
        </div>
        
        <div class="form-group">
          <label>Business Name <span class="required">*</span></label>
          <input type="text" id="business_name" name="business_name" required 
                 placeholder="e.g., My Company" />
        </div>
        
        <div class="form-group">
          <label>System Prompt / Instructions <span class="required">*</span></label>
          <textarea id="system_prompt" name="system_prompt" required
                    placeholder="Describe your business, services, products, and how the chatbot should behave. Be specific about what information to share and how to interact with customers."></textarea>
          <div class="help-text">This is the main customization - describe your business, services, and chatbot behavior</div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Primary Goal</label>
            <input type="text" id="primary_goal" name="primary_goal" 
                   placeholder="e.g., Generate more leads" />
          </div>
          
          <div class="form-group">
            <label>Personality</label>
            <input type="text" id="personality" name="personality" 
                   placeholder="e.g., Friendly and professional" />
          </div>
        </div>
        
        <div class="form-group">
          <label>Greeting Message</label>
          <input type="text" id="greeting_message" name="greeting_message" 
                 placeholder="e.g., Hi! How can we help you today?" />
          <div class="help-text">Initial message shown when chat opens</div>
        </div>
        
        <div class="form-group">
          <label>Appointment/Booking Link</label>
          <input type="url" id="appointment_link" name="appointment_link" 
                 placeholder="https://example.com/book" />
          <div class="help-text">URL for booking appointments or scheduling</div>
        </div>
        
        <div class="form-group">
          <label>Privacy Statement</label>
          <textarea id="privacy_statement" name="privacy_statement"
                    placeholder="We collect your information only to provide better service..."></textarea>
          <div class="help-text">Shown when collecting customer information</div>
        </div>

        <div class="form-group">
          <label>Primary CTAs (JSON)</label>
          <textarea id="primary_ctas" name="primary_ctas"
                    placeholder='[{"label":"Book an Appointment","action":"send"}]'></textarea>
          <div class="help-text">JSON array of CTA objects: label, action (send/show_secondary), message (optional)</div>
        </div>

        <div class="form-group">
          <label>Secondary CTAs (JSON)</label>
          <textarea id="secondary_ctas" name="secondary_ctas"
                    placeholder='[{"label":"Website Design Services","action":"send"}]'></textarea>
          <div class="help-text">Shown after clicking a CTA with action show_secondary</div>
        </div>

        <div class="form-group">
          <label>CTA Tree (JSON) - Tree-based Structure</label>
          <textarea id="cta_tree" name="cta_tree" style="min-height: 300px; font-family: monospace;"
                    placeholder='{"learn_services": {"id": "learn_services", "label": "Learn About Services", "action": "show_children", "children": ["digital_agency", "website_design"]}, ...}'></textarea>
          <div class="help-text">
            <strong>Tree-based CTA structure.</strong> Each CTA has: id, label, action (show_children/redirect/send), children (array of child IDs), url (if redirect), message (if send).
            See team lead's document for complete example.
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Theme Color</label>
            <input type="color" id="theme_color" name="theme_color" value="#2563eb" />
          </div>
          
          <div class="form-group">
            <label>Widget Position</label>
            <select id="widget_position" name="widget_position">
              <option value="center">Center</option>
              <option value="bottom-right">Bottom Right</option>
              <option value="bottom-left">Bottom Left</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Website URL</label>
            <input type="url" id="website_url" name="website_url" 
                   placeholder="https://example.com" />
          </div>
          
          <div class="form-group">
            <label>Contact Email</label>
            <input type="email" id="contact_email" name="contact_email" 
                   placeholder="contact@example.com" />
          </div>
        </div>
        
        <div class="form-group">
          <label>Contact Phone</label>
          <input type="text" id="contact_phone" name="contact_phone" 
                 placeholder="+1 (555) 123-4567" />
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="voice_enabled" name="voice_enabled" value="true" />
            Enable Voice Bot (Phone Calls)
          </label>
          <div class="help-text">Check this to enable phone call functionality for this business. Not all tenants need voice capabilities.</div>
        </div>
        
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
          <button type="button" class="btn btn-secondary" onclick="loadBusinesses()">üìã View All Businesses</button>
          <button type="button" class="btn btn-secondary" onclick="loadGoAccelTemplate()">üöÄ Load GoAccel Template</button>
          <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ Clear Form</button>
        </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="preview-section">
        <h2>üìã Configured Businesses</h2>
        <p style="color: #6b7280; font-size: 13px; margin-bottom: 16px; background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #2563eb;">
          üí° <strong>How it works:</strong> Click "Create New Business" to show the form ‚Üí Fill in your business information ‚Üí Click "Save Configuration" ‚Üí Your chatbot is automatically created! Click "Test Chatbot" button to see it in action.
        </p>
        <div id="businessList" class="business-list"></div>
      </div>
      
      <div class="preview-section">
        <h2>üîó Integration Code</h2>
        <p style="margin-bottom: 12px; color: #6b7280;">Use this code in your website to embed the chatbot:</p>
        <div class="code-block" id="integrationCode">
          &lt;script&gt;
            const CHATBOT_CONFIG = {
              businessId: "<span id="code_business_id">your-business-id</span>"
            };
          &lt;/script&gt;
          &lt;iframe src="${API_BASE}/?business_id=<span id="code_business_id2">your-business-id</span>" 
                   style="width: 440px; height: 600px; border: none;"&gt;&lt;/iframe&gt;
        </div>
      </div>
    </div>
  </div>

  <!-- Scraping Progress Modal -->
  <div id="scrapingModal" class="modal-overlay">
    <div class="modal">
      <h2>üåê Building Knowledge Base</h2>
      <div class="modal-status" id="modalStatus">Initializing...</div>
      <div class="modal-message" id="modalMessage">Preparing to scrape your website...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-close" onclick="closeScrapingModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay delete-modal">
    <div class="modal">
      <h2>‚ö†Ô∏è Delete Business</h2>
      <p id="deleteModalMessage">Are you sure you want to delete this business? This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn btn-close" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // Detects the current origin or defaults to localhost (port 80)
    const API_BASE = window.location.protocol === 'file:' 
      ? 'http://localhost:8000'
      : window.location.origin;

    // Admin API Key - Get from localStorage or input field
    let ADMIN_API_KEY = localStorage.getItem('admin_api_key');
    
    // Function to get API key from input field
    function getApiKeyFromInput() {
      const input = document.getElementById('adminApiKey');
      if (input && input.value) {
        ADMIN_API_KEY = input.value;
        localStorage.setItem('admin_api_key', input.value);
        return input.value;
      }
      return ADMIN_API_KEY;
    }
    
    // Update API key when input changes
    document.getElementById('adminApiKey').addEventListener('input', function(e) {
      if (e.target.value) {
        ADMIN_API_KEY = e.target.value;
        localStorage.setItem('admin_api_key', e.target.value);
      }
    });
    
    // Load API key from localStorage into input field
    if (ADMIN_API_KEY) {
      document.getElementById('adminApiKey').value = ADMIN_API_KEY;
    }
    
    // Helper function to get headers with API key
    function getAdminHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const apiKey = getApiKeyFromInput();
      if (apiKey) {
        headers['X-Admin-API-Key'] = apiKey;
      }
      return headers;
    }
    
    // Function to show error if API key is missing
    function requireApiKey() {
      const apiKey = getApiKeyFromInput();
      if (!apiKey) {
        showAlert('Please enter your Admin API Key in the field above.', 'error');
        document.getElementById('adminApiKey').focus();
        return false;
      }
      return true;
    }

    // Update integration code display with dynamic API_BASE
    function updateIntegrationCodeOnLoad() {
      const integrationCodeEl = document.getElementById('integrationCode');
      if (integrationCodeEl) {
        updateIntegrationCode('your-business-id');
      }
    }

    const DEFAULT_PRIMARY_CTAS = [
      { label: "Book an Appointment", action: "send" },
      { label: "Speak to Sales", action: "send" },
      { label: "Send More Information", action: "show_secondary" },
    ];

    const DEFAULT_SECONDARY_CTAS = [
      { label: "Website Design Services", action: "send" },
      { label: "Digital Agency Services", action: "send" },
      { label: "Business Growth Services", action: "send" },
      { label: "CRM Software Platform", action: "send" },
      {
        label: "All of the Above",
        action: "send",
        message: "Can you explain Website Design Services, Digital Agency Services, Business Growth Services, CRM Software Platform?",
      },
    ];

    function setDefaultCtas() {
      document.getElementById('primary_ctas').value = JSON.stringify(DEFAULT_PRIMARY_CTAS, null, 2);
      document.getElementById('secondary_ctas').value = JSON.stringify(DEFAULT_SECONDARY_CTAS, null, 2);
    }
    
    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
    
    function clearForm() {
      document.getElementById('businessForm').reset();
      document.getElementById('theme_color').value = '#2563eb';
      setDefaultCtas();
    }
    
    function loadGoAccelTemplate() {
      // Fill all fields with GoAccel default values
      document.getElementById('business_id').value = 'goaccel-website';
      document.getElementById('business_name').value = 'GoAccel';
      document.getElementById('system_prompt').value = `GoAccel is an all-in-one growth and operations system built specifically for home services and skilled trade businesses. We combine customer acquisition, automation, CRM, scheduling, and operational systems into a single platform designed to help owners scale predictably and build long-term enterprise value.

Our services include:
- Digital Agency Solutions: Full-service digital agency/lead gen services including websites, paid ads, and conversion tracking
- CRM Software: Customer relationship management, deal pipeline management, business management software
- Marketing Automation: Automated appointment booking, lead nurturing, marketing campaign management
- Business Listing Management: Customer review management, data enhancement, database reactivation

We serve industries including HVAC, plumbing, electrical, window cleaning, appliance repair, carpet cleaning, handyman, cleaning & janitorial, garage door, lawn care, pest control, custom home building, pool & spa service, fireplace & chimney, custom remodeling, locksmith, landscaping, painting contractors, junk removal, property maintenance, roofing, and mechanic services.

Your role is to help potential customers understand how GoAccel can help their home services business grow. Be friendly, knowledgeable, and focus on how we can help them achieve predictable growth and build business value.`;
      
      document.getElementById('primary_goal').value = 'Help home services businesses scale predictably and build long-term enterprise value';
      document.getElementById('personality').value = 'Friendly, knowledgeable, and growth-focused';
      document.getElementById('greeting_message').value = 'Hi! Welcome to GoAccel. I\'m here to help you understand how we can accelerate your home services business growth. What would you like to know?';
      document.getElementById('appointment_link').value = 'https://warmprospect.com/goaccel-website/';
      document.getElementById('privacy_statement').value = 'We collect your information only to provide better service and connect you with the right solutions for your business. Your data is secure and will not be shared with third parties.';
      document.getElementById('website_url').value = 'https://warmprospect.com/goaccel-website/';
      document.getElementById('contact_email').value = 'info@goaccel.com';
      document.getElementById('contact_phone').value = '855.915.0747';
      document.getElementById('theme_color').value = '#667eea';
      document.getElementById('widget_position').value = 'center';
      
      // Set GoAccel-specific CTAs
      document.getElementById('primary_ctas').value = JSON.stringify([
        {"label": "Get Free Visibility Scan", "action": "send", "message": "I'd like to get a free visibility scan for my business."},
        {"label": "Book a Growth Call", "action": "send", "message": "I want to book a 15-minute growth call to learn more."},
        {"label": "Learn About Services", "action": "show_secondary"}
      ], null, 2);
      
      document.getElementById('secondary_ctas').value = JSON.stringify([
        {"label": "Digital Agency Solutions", "action": "send", "message": "Tell me about your digital agency solutions and website design services."},
        {"label": "CRM Software", "action": "send", "message": "I want to learn about your CRM software for home services businesses."},
        {"label": "Marketing Automation", "action": "send", "message": "How does your marketing automation work?"},
        {"label": "Industries We Serve", "action": "send", "message": "Which industries do you serve?"},
        {"label": "Pricing Information", "action": "send", "message": "What are your pricing options?"}
      ], null, 2);
      
      // Update integration code
      updateIntegrationCode('goaccel-website');
      
      showAlert('‚úÖ GoAccel template loaded! Review and customize the fields, then click "Save Configuration".', 'success');
    }
    
    async function loadBusinesses() {
      if (!requireApiKey()) return;
      
      try {
        console.log('Loading businesses from:', `${API_BASE}/admin/business`);
        const res = await fetch(`${API_BASE}/admin/business`, {
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            // API key issue - clear and show error
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        console.log('Businesses loaded:', data);
        
        const listEl = document.getElementById('businessList');
        if (!data.businesses || Object.keys(data.businesses).length === 0) {
          listEl.innerHTML = '<p style="color: #6b7280;">No businesses configured yet.</p>';
          return;
        }
        
        listEl.innerHTML = Object.values(data.businesses).map(business => `
          <div class="business-card">
            <div>
              <h3>${business.business_name || business.business_id}</h3>
              <p>ID: ${business.business_id} ‚Ä¢ Updated: ${new Date(business.updated_at).toLocaleString()}</p>
            </div>
            <div class="business-actions">
              <button class="btn btn-secondary btn-small" onclick="loadBusiness('${business.business_id}')">Edit</button>
              <a href="${API_BASE}/bot?business_id=${business.business_id}" target="_blank" class="btn btn-primary btn-small" style="text-decoration: none; display: inline-block;">üí¨ Test Chatbot</a>
              <button class="btn btn-danger btn-small" onclick="showDeleteModal('${business.business_id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading businesses:', err);
        showAlert('Failed to load businesses: ' + err.message, 'error');
      }
    }
    
    async function loadBusiness(businessId) {
      if (!requireApiKey()) return;
      
      try {
        console.log('Loading business:', businessId);
        const res = await fetch(`${API_BASE}/admin/business/${businessId}`, {
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        const config = data.config;
        console.log('Business config loaded:', config);
        
        // Populate form
        document.getElementById('business_id').value = config.business_id || '';
        document.getElementById('business_name').value = config.business_name || '';
        document.getElementById('system_prompt').value = config.system_prompt || '';
        document.getElementById('primary_goal').value = config.primary_goal || '';
        document.getElementById('personality').value = config.personality || '';
        document.getElementById('greeting_message').value = config.greeting_message || '';
        document.getElementById('appointment_link').value = config.appointment_link || '';
        document.getElementById('privacy_statement').value = config.privacy_statement || '';
        document.getElementById('theme_color').value = config.theme_color || '#2563eb';
        document.getElementById('widget_position').value = config.widget_position || 'center';
        document.getElementById('website_url').value = config.website_url || '';
        document.getElementById('contact_email').value = config.contact_email || '';
        document.getElementById('contact_phone').value = config.contact_phone || '';
        document.getElementById('primary_ctas').value = JSON.stringify(
          config.primary_ctas || DEFAULT_PRIMARY_CTAS,
          null,
          2
        );
        document.getElementById('secondary_ctas').value = JSON.stringify(
          config.secondary_ctas || DEFAULT_SECONDARY_CTAS,
          null,
          2
        );
        
        // Load CTA tree if available
        document.getElementById('cta_tree').value = JSON.stringify(
          config.cta_tree || {},
          null,
          2
        );
        
        // Update integration code
        updateIntegrationCode(config.business_id);
        
        // Load voice_enabled checkbox
        document.getElementById('voice_enabled').checked = config.voice_enabled || false;
        
        // Show form modal when editing
        const modal = document.getElementById('businessFormModal');
        const btn = document.getElementById('toggleFormBtn');
        modal.classList.add('active');
        btn.textContent = '‚ùå Cancel';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        
        showAlert('Business configuration loaded! <a href="' + API_BASE + '/bot?business_id=' + businessId + '" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">Test Your Chatbot ‚Üí</a>', 'success');
      } catch (err) {
        console.error('Error loading business:', err);
        showAlert('Failed to load business: ' + err.message, 'error');
      }
    }
    
    let pendingDeleteBusinessId = null;
    
    function showDeleteModal(businessId) {
      pendingDeleteBusinessId = businessId;
      const modal = document.getElementById('deleteModal');
      const messageEl = document.getElementById('deleteModalMessage');
      messageEl.textContent = `Are you sure you want to delete business "${businessId}"? This action cannot be undone.`;
      modal.classList.add('active');
    }
    
    function closeDeleteModal() {
      const modal = document.getElementById('deleteModal');
      modal.classList.remove('active');
      pendingDeleteBusinessId = null;
    }
    
    async function confirmDelete() {
      if (!pendingDeleteBusinessId) return;
      
      if (!requireApiKey()) {
        closeDeleteModal();
        return;
      }
      
      const businessId = pendingDeleteBusinessId;
      closeDeleteModal();
      
      try {
        console.log('Deleting business:', businessId);
        const res = await fetch(`${API_BASE}/admin/business/${businessId}`, {
          method: 'DELETE',
          headers: getAdminHeaders()
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        console.log('Delete response:', data);
        
        if (data.success) {
          showAlert('Business deleted successfully!', 'success');
          loadBusinesses();
        } else {
          showAlert('Failed to delete: ' + (data.detail || 'Unknown error'), 'error');
        }
      } catch (err) {
        console.error('Error deleting business:', err);
        showAlert('Failed to delete business: ' + err.message, 'error');
      }
    }
    
    function updateIntegrationCode(businessId) {
      const integrationCodeEl = document.getElementById('integrationCode');
      const safeBusinessId = businessId.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      integrationCodeEl.innerHTML = `
&lt;script&gt;
  const CHATBOT_CONFIG = {
    businessId: "${safeBusinessId}"
  };
&lt;/script&gt;
&lt;iframe src="${API_BASE}/bot?business_id=${safeBusinessId}" 
         style="width: 440px; height: 600px; border: none;"&gt;&lt;/iframe&gt;
      `.trim();
    }
    
    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!requireApiKey()) return;
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      let primaryCtas;
      let secondaryCtas;
      let ctaTree = {};
      try {
        primaryCtas = JSON.parse(data.primary_ctas || "[]");
        secondaryCtas = JSON.parse(data.secondary_ctas || "[]");
        if (data.cta_tree && data.cta_tree.trim()) {
          ctaTree = JSON.parse(data.cta_tree);
        }
      } catch (err) {
        showAlert('CTAs and CTA Tree must be valid JSON.', 'error');
        return;
      }
      data.primary_ctas = primaryCtas;
      data.secondary_ctas = secondaryCtas;
      data.cta_tree = ctaTree;
      data.voice_enabled = data.voice_enabled === 'true' || data.voice_enabled === true;
      
      // Validate required fields
      if (!data.business_id || !data.business_name || !data.system_prompt) {
        showAlert('‚ùå Please fill in all required fields (Business ID, Name, and System Prompt)', 'error');
        return;
      }
      
      try {
        console.log('Saving business:', data.business_id);
        const res = await fetch(`${API_BASE}/admin/business`, {
          method: 'POST',
          headers: getAdminHeaders(),
          body: JSON.stringify(data)
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          if (res.status === 403 || res.status === 500) {
            localStorage.removeItem('admin_api_key');
            ADMIN_API_KEY = null;
            document.getElementById('adminApiKey').value = '';
            showAlert('Invalid or missing API key. Please enter a valid Admin API Key.', 'error');
            document.getElementById('adminApiKey').focus();
            return;
          }
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        console.log('Save response:', result);
        
        if (result.success) {
          updateIntegrationCode(data.business_id);
          loadBusinesses();
          
          // Check if scraping was started
          if (result.scraping_started && data.website_url) {
            showScrapingModal(data.business_id);
            startScrapingPoll(data.business_id);
          } else {
            showAlert('‚úÖ Configuration saved successfully! Your chatbot is ready. <a href="' + API_BASE + '/bot?business_id=' + data.business_id + '" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">Test Chatbot ‚Üí</a>', 'success');
            // Hide form after successful save
            toggleForm();
          }
        } else {
          showAlert('‚ùå Failed to save: ' + (result.detail || 'Unknown error'), 'error');
        }
      } catch (err) {
        console.error('Error saving business:', err);
        showAlert('‚ùå Error: ' + err.message, 'error');
      }
    });
    
    // Update integration code when business_id changes
    document.getElementById('business_id').addEventListener('input', (e) => {
      updateIntegrationCode(e.target.value || 'your-business-id');
    });
    
    // Scraping Modal Functions
    function showScrapingModal(businessId) {
      const modal = document.getElementById('scrapingModal');
      modal.classList.add('active');
      updateScrapingStatus(businessId);
    }
    
    function closeScrapingModal() {
      const modal = document.getElementById('scrapingModal');
      modal.classList.remove('active');
    }
    
    function updateScrapingStatus(businessId) {
      fetch(`${API_BASE}/admin/business/${businessId}/scraping-status`, {
        headers: getAdminHeaders()
      })
        .then(res => res.json())
        .then(status => {
          const statusEl = document.getElementById('modalStatus');
          const messageEl = document.getElementById('modalMessage');
          const progressEl = document.getElementById('progressFill');
          
          let statusText = '';
          let messageText = status.message || '';
          let progress = status.progress || 0;
          
          switch(status.status) {
            case 'pending':
              statusText = '‚è≥ Preparing...';
              break;
            case 'scraping':
              statusText = 'üåê Scraping Website...';
              progress = Math.max(progress, 20);
              break;
            case 'indexing':
              statusText = 'üìö Building Knowledge Base...';
              progress = Math.max(progress, 80);
              break;
            case 'completed':
              statusText = '‚úÖ Complete!';
              progress = 100;
              messageText = 'Your chatbot is now ready to use with the scraped knowledge base!';
              setTimeout(() => {
                closeScrapingModal();
                showAlert('‚úÖ Knowledge base built successfully! Your chatbot is ready. <a href="' + API_BASE + '/bot?business_id=' + businessId + '" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">Test Chatbot ‚Üí</a>', 'success');
              }, 2000);
              return; // Stop polling
            case 'failed':
              statusText = '‚ùå Failed';
              messageText = status.message || 'Scraping failed. Please try again.';
              progress = 0;
              return; // Stop polling
            default:
              statusText = '‚è≥ Waiting...';
          }
          
          statusEl.textContent = statusText;
          messageEl.textContent = messageText;
          progressEl.style.width = progress + '%';
        })
        .catch(err => {
          console.error('Error checking scraping status:', err);
        });
    }
    
    let scrapingPollInterval = null;
    
    function startScrapingPoll(businessId) {
      // Clear any existing interval
      if (scrapingPollInterval) {
        clearInterval(scrapingPollInterval);
      }
      
      // Poll every 2 seconds
      scrapingPollInterval = setInterval(() => {
        updateScrapingStatus(businessId);
      }, 2000);
      
      // Stop polling after 15 minutes (timeout)
      setTimeout(() => {
        if (scrapingPollInterval) {
          clearInterval(scrapingPollInterval);
          scrapingPollInterval = null;
        }
      }, 15 * 60 * 1000);
    }
    
    // Toggle form modal visibility
    function toggleForm() {
      const modal = document.getElementById('businessFormModal');
      const btn = document.getElementById('toggleFormBtn');
      if (modal.classList.contains('active')) {
        modal.classList.remove('active');
        btn.textContent = '‚ûï Create New Business';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        clearForm();
      } else {
        modal.classList.add('active');
        btn.textContent = '‚ùå Cancel';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      }
    }
    
    // Close form modal when clicking overlay
    document.getElementById('businessFormModal').addEventListener('click', function(e) {
      if (e.target === this) {
        toggleForm();
      }
    });
    
    // Set up delete confirmation button
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
    
    // Close delete modal when clicking overlay
    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });
    
    // Load businesses on page load
    setDefaultCtas();
    updateIntegrationCodeOnLoad();
    loadBusinesses();
  </script>
</body>
</html>

