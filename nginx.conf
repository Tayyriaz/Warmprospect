# Nginx configuration for Chatbot API (Template with environment variables)
# This file uses ${VAR} syntax for environment variable substitution
# Variables are loaded from .env file during deployment via deploy.sh
# Place at: /etc/nginx/sites-available/chatbot-api
# Enable: sudo ln -s /etc/nginx/sites-available/chatbot-api /etc/nginx/sites-enabled/
# Test: sudo nginx -t
# Reload: sudo systemctl reload nginx
#
# Configuration variables (set in .env):
# - NGINX_SERVER_NAME: Server name(s) for SSL
# - NGINX_SSL_CERT_PATH: Path to SSL certificate
# - NGINX_SSL_KEY_PATH: Path to SSL private key
# - NGINX_PROXY_PASS: Backend URL (uses PORT from .env)
#
# Architecture:
# - Nginx listens on ports 80 (HTTP) and 443 (HTTPS) - public-facing
# - FastAPI runs on port ${PORT} (HTTP, internal only) - configured in systemd service
# - Nginx proxies external requests to internal FastAPI service
#
# Note: Rate limiting (limit_req_zone) must be defined in the main nginx.conf http block,
# not in site configs. Add to /etc/nginx/nginx.conf if needed:
#   limit_req_zone $binary_remote_addr zone=chatbot_api_limit:10m rate=10r/s;
#   limit_req_zone $binary_remote_addr zone=chatbot_chat_limit:10m rate=5r/s;

# HTTP server - redirect to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name ${NGINX_SERVER_NAME};
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS server on port ${NGINX_HTTPS_PORT} (default: 443)
server {
    listen ${NGINX_HTTPS_PORT} ssl http2;
    listen [::]:${NGINX_HTTPS_PORT} ssl http2;
    # Additional HTTPS port (uncomment in generated config if NGINX_ADDITIONAL_HTTPS_PORT is set)
    # listen ${NGINX_ADDITIONAL_HTTPS_PORT} ssl http2;
    # listen [::]:${NGINX_ADDITIONAL_HTTPS_PORT} ssl http2;
    server_name ${NGINX_SERVER_NAME};

    # SSL certificates (Let's Encrypt - adjust path if different)
    ssl_certificate ${NGINX_SSL_CERT_PATH};
    ssl_certificate_key ${NGINX_SSL_KEY_PATH};

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Logging
    access_log /var/log/nginx/chatbot_api_access.log;
    error_log /var/log/nginx/chatbot_api_error.log;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Max upload size
    client_max_body_size 10M;

    # Main application (FastAPI on localhost:${PORT} - HTTP, internal only)
    location / {
        proxy_pass ${NGINX_PROXY_PASS};
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_buffering off;
    }

    # Chat endpoint
    location /chat {
        proxy_pass ${NGINX_PROXY_PASS};
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeout for chat requests
        proxy_read_timeout 120s;
    }

    # WebSocket (Twilio media stream)
    location /media-stream {
        proxy_pass ${NGINX_PROXY_PASS};
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Long timeout for WebSocket connections
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # Health check endpoint (optional)
    location /health {
        proxy_pass ${NGINX_PROXY_PASS}/health;
        access_log off;
    }
}
